<!DOCTYPE html>
<html lang="en">
<head>
  <title>FMGE/NEET PG Study Scheduler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: 'Inter', Arial, sans-serif; background: #f7fafc; color:#232c40; margin:0; }
    .container { max-width:740px; margin:30px auto 36px; background:#fff; border-radius:18px; box-shadow:0 2px 12px #23262f15; padding:24px 28px;}
    h1 { margin-top:0; font-size:2em; font-weight:700; color:#2562cf;}
    .card-row { display:flex; flex-wrap:wrap; gap:15px; align-items:center; margin-bottom:18px;}
    label { font-weight:500; margin-right:7px;}
    input, select, button { font-family:inherit; font-size:.98em;}
    .resource-row { background:#f2fcff; border-radius:9px; padding:7px 6px 7px 7px; margin-bottom:14px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
    .remove-btn { margin-left:10px; color:#bc2d2d; background:none; border:none; font-size:1.07em; cursor:pointer; }
    .auto-count-label { color:#2562cf; font-weight:600; margin-left:2px; }
    .schedule-list { margin-top:24px; }
    .schedule-day { margin-bottom:11px; padding:11px 13px; border-radius:11px; background:#f6f8fa;}
    .task-row { display:flex; align-items:center; gap:13px; margin-top:7px; background:#f9fcff; border-radius:7px; padding:7px; }
    .progress-check { transform:scale(1.23); margin-right:0; }
    .notes { margin-top:7px; color: #265292; font-size:.99em;}
    .btn-row { display:flex; gap:14px; justify-content:right;}
    #toast-notify { position:fixed;z-index:9999;left:50%;top:32px;transform:translateX(-50%);background:#26994a;color:#fff;font-weight:600;
      border-radius:10px;box-shadow:0 4px 18px #0002;padding:12px 36px;font-size:1.07em;opacity:0;transition:opacity .32s,top .32s;pointer-events:none;}
    #toast-notify.show { opacity:1;top:70px;pointer-events:auto;}
    @media(max-width:700px){.container{max-width:99vw;padding:10px 2vw;}.card-row,.resource-row,.btn-row{flex-direction:column;align-items:stretch;gap:8px;}}
    .disabled-input { background:#e5eaf1 !important; color:#999 !important;}
  </style>
</head>
<body>
<div id="toast-notify"></div>
<div class="container">
  <h1>FMGE/NEET PG Study Scheduler</h1>
  <form id="study-form" autocomplete="off">
    <div class="card-row">
      <label>Study hours per day:
        <input type="number" id="study-hours-per-day" min="1" max="24" value="3">
      </label>
      <label>Start:
        <input type="date" id="start-date" required>
      </label>
      <label>End:
        <input type="date" id="end-date" required>
      </label>
    </div>
    <div id="resource-list">
      <div class="resource-row">
        <label>Resource:
          <input type="text" class="resource-search" list="resource-library" autocomplete="off" required style="min-width:160px;">
          <datalist id="resource-library">
            <option value="Marrow Video - Anatomy">
            <option value="Marrow Video - Physiology">
            <option value="Marrow Video - Biochemistry">
            <option value="Marrow Video - Pathology">
            <option value="Marrow Video - Pharmacology">
            <option value="Marrow Video - Microbiology">
            <option value="Marrow Video - Forensic Medicine">
            <option value="Marrow Video - Community Medicine">
            <option value="Marrow Video - Medicine">
            <option value="Marrow Video - Surgery">
            <option value="Marrow Video - Obstetrics & Gynecology">
            <option value="Marrow Video - Pediatrics">
            <option value="Marrow Video - Ophthalmology">
            <option value="Marrow Video - ENT">
            <option value="Marrow Video - Psychiatry">
            <option value="Marrow Video - Dermatology">
            <option value="Marrow Video - Radiology">
            <option value="Marrow Video - Orthopedics">
            <option value="Marrow Video - Anesthesia">
            <option value="Prepladder Video - Anatomy">
            <option value="Prepladder Video - Physiology">
            <option value="Prepladder Video - Biochemistry">
            <option value="Prepladder Video - Pathology">
            <option value="Prepladder Video - Pharmacology">
            <option value="Prepladder Video - Microbiology">
            <option value="Prepladder Video - Forensic Medicine">
            <option value="Prepladder Video - Community Medicine">
            <option value="Prepladder Video - Medicine">
            <option value="Prepladder Video - Surgery">
            <option value="Prepladder Video - Obstetrics & Gynecology">
            <option value="Prepladder Video - Pediatrics">
            <option value="Prepladder Video - Ophthalmology">
            <option value="Prepladder Video - ENT">
            <option value="Prepladder Video - Psychiatry">
            <option value="Prepladder Video - Dermatology">
            <option value="Prepladder Video - Radiology">
            <option value="Prepladder Video - Orthopedics">
            <option value="Prepladder Video - Anesthesia">
            <option value="Marrow QBank">
            <option value="Prepladder QBank">
            <option value="DAMS QBank">
            <option value="DocTutorials QBank">
            <option value="Robbins Pathology">
          </datalist>
        </label>
        <label>Type:
          <select class="resource-type-dropdown">
            <option value="video">Video</option>
            <option value="qbank">QBank</option>
            <option value="book">Book</option>
            <option value="flashcards">Flashcards</option>
            <option value="other">Other</option>
          </select>
        </label>
        <label>
          Total:
          <input type="number" class="pages" required style="width:67px;">
          <span class="auto-count-label">(auto/manual)</span>
        </label>
        <label>
          Rate/hr: <input type="number" class="rate-per-hour" min="1" value="10" style="width:55px;">
        </label>
        <label>
          <input type="checkbox" class="no-total-checkbox">
          <span>No total/end</span>
        </label>
        <label>
          Priority:
          <select class="priority-dropdown">
            <option value="high">High ⭐</option>
            <option value="medium" selected>Medium</option>
            <option value="low">Low</option>
          </select>
        </label>
        <label>Tag: <input type="text" class="resource-tag" placeholder="Tag" style="width:65px;"></label>
        <label>Note: <input type="text" class="resource-note" placeholder="Note" style="width:105px;"></label>
        <label>
          Interval:
          <select class="interval-dropdown" style="width:67px;">
            <option value="1">Daily</option>
            <option value="2">Every 2nd</option>
            <option value="3">Every 3rd</option>
            <option value="7">Weekly</option>
          </select>
        </label>
        <button type="button" class="remove-btn" style="display:none;">✖</button>
      </div>
    </div>
    <div class="btn-row" style="margin-bottom:10px;">
      <button type="button" id="add-resource-btn">Add Resource</button>
      <button type="submit">Create Schedule</button>
      <button type="button" id="reset-btn">Reset</button>
      <button type="button" id="backup-btn">Backup</button>
      <button type="button" id="restore-btn">Restore</button>
      <button type="button" id="export-gcal-btn">Export to Google Calendar</button>
      <button type="button" id="gcal-direct-btn">Add directly to Google Calendar</button>
      <input type="file" id="restore-file" style="display:none;">
    </div>
  </form>
  <div class="schedule-list" id="schedule-list"></div>
</div>
<script>
const resourceLibrary = {
  "Marrow Video - Anatomy": { type: "video", total: 84 },
  "Marrow Video - Physiology": { type: "video", total: null },
  "Marrow Video - Biochemistry": { type: "video", total: 50 },
  "Marrow Video - Pathology": { type: "video", total: 76 },
  "Marrow Video - Pharmacology": { type: "video", total: null },
  "Marrow Video - Microbiology": { type: "video", total: null },
  "Marrow Video - Forensic Medicine": { type: "video", total: 38 },
  "Marrow Video - Community Medicine": { type: "video", total: 100 },
  "Marrow Video - Medicine": { type: "video", total: 202 },
  "Marrow Video - Surgery": { type: "video", total: 94 },
  "Marrow Video - Obstetrics & Gynecology": { type: "video", total: 109 },
  "Marrow Video - Pediatrics": { type: "video", total: 58 },
  "Marrow Video - Ophthalmology": { type: "video", total: 40 },
  "Marrow Video - ENT": { type: "video", total: 64 },
  "Marrow Video - Psychiatry": { type: "video", total: 25 },
  "Marrow Video - Dermatology": { type: "video", total: 27 },
  "Marrow Video - Radiology": { type: "video", total: 41 },
  "Marrow Video - Orthopedics": { type: "video", total: 29 },
  "Marrow Video - Anesthesia": { type: "video", total: 31 },
  "Prepladder Video - Anatomy": { type: "video", total: 103 },
  "Prepladder Video - Physiology": { type: "video", total: 60 },
  "Prepladder Video - Biochemistry": { type: "video", total: null },
  "Prepladder Video - Pathology": { type: "video", total: 77 },
  "Prepladder Video - Pharmacology": { type: "video", total: 83 },
  "Prepladder Video - Microbiology": { type: "video", total: 52 },
  "Prepladder Video - Forensic Medicine": { type: "video", total: 34 },
  "Prepladder Video - Community Medicine": { type: "video", total: 117 },
  "Prepladder Video - Medicine": { type: "video", total: 141 },
  "Prepladder Video - Surgery": { type: "video", total: 70 },
  "Prepladder Video - Obstetrics & Gynecology": { type: "video", total: 112 },
  "Prepladder Video - Pediatrics": { type: "video", total: 74 },
  "Prepladder Video - Ophthalmology": { type: "video", total: 35 },
  "Prepladder Video - ENT": { type: "video", total: 55 },
  "Prepladder Video - Psychiatry": { type: "video", total: 20 },
  "Prepladder Video - Dermatology": { type: "video", total: 29 },
  "Prepladder Video - Radiology": { type: "video", total: 27 },
  "Prepladder Video - Orthopedics": { type: "video", total: 21 },
  "Prepladder Video - Anesthesia": { type: "video", total: 22 },
  "Marrow QBank": { type: "qbank", total: 16367 },
  "Prepladder QBank": { type: "qbank", total: 19185 },
  "DAMS QBank": { type: "qbank", total: 1682 },
  "DocTutorials QBank": { type: "qbank", total: 13228 },
  "Robbins Pathology": { type: "book", total: 1024 }
};

function setupResourceAutofill(row) {
  const searchBox = row.querySelector('.resource-search');
  const typeSel = row.querySelector('.resource-type-dropdown');
  const totalBox = row.querySelector('.pages');
  const noTotalChk = row.querySelector('.no-total-checkbox');
  // resource autofill
  searchBox.addEventListener('change', function () {
    const val = searchBox.value.trim();
    if (resourceLibrary.hasOwnProperty(val)) {
      const meta = resourceLibrary[val];
      typeSel.value = meta.type;
      typeSel.disabled = true;
      if (meta.total) {
        totalBox.value = meta.total;
        totalBox.readOnly = true;
        totalBox.classList.add("disabled-input");
      } else {
        totalBox.value = '';
        totalBox.readOnly = false;
        totalBox.classList.remove("disabled-input");
      }
    } else {
      typeSel.value = "other";
      typeSel.disabled = false;
      totalBox.value = '';
      totalBox.readOnly = false;
      totalBox.classList.remove("disabled-input");
    }
  });
  totalBox.addEventListener('focus', function () {
    if (!totalBox.readOnly) totalBox.classList.remove("disabled-input");
  });
  typeSel.onchange = function () {
    typeSel.disabled = false;
    totalBox.readOnly = false;
    totalBox.classList.remove("disabled-input");
  };
  // noTotal checkbox effects
  function handleNoTotalChange() {
    if (noTotalChk.checked) {
      totalBox.value = '';
      totalBox.readOnly = true;
      totalBox.classList.add("disabled-input");
      totalBox.removeAttribute('required');
    } else {
      totalBox.readOnly = false;
      totalBox.classList.remove("disabled-input");
      totalBox.setAttribute('required', '');
    }
  }
  noTotalChk.addEventListener('change', handleNoTotalChange);
  handleNoTotalChange(); // initial state
}
function addResourceRow(resourceVal = "", typeVal = "video", totalVal = "", rateVal = "10") {
  const resourceList = document.getElementById('resource-list');
  const newRow = resourceList.firstElementChild.cloneNode(true);
  newRow.querySelector('.resource-search').value = resourceVal;
  newRow.querySelector('.resource-type-dropdown').value = typeVal;
  newRow.querySelector('.pages').value = totalVal;
  newRow.querySelector('.rate-per-hour').value = rateVal;
  setupResourceAutofill(newRow);
  const removeBtn = newRow.querySelector('.remove-btn');
  removeBtn.style.display = 'inline';
  removeBtn.addEventListener('click', function () { newRow.remove(); });
  resourceList.appendChild(newRow);
}
setupResourceAutofill(document.querySelector('.resource-row'));
document.getElementById('add-resource-btn').addEventListener('click', function () { addResourceRow(); });

document.getElementById('study-form').addEventListener('submit', function (e) {
  e.preventDefault();
  const startDate = document.getElementById('start-date').value;
  const endDate = document.getElementById('end-date').value;
  if (!startDate || !endDate) return showToast("Start/end date required!", "#bc2d2d");
  const start = new Date(startDate), end = new Date(endDate);
  if (start > end) return showToast("End date must be after start!", "#bc2d2d");
  const hoursPerDay = +document.getElementById('study-hours-per-day').value;
  const resourceRows = Array.from(document.querySelectorAll('.resource-row'));
  let plan = [];
  resourceRows.forEach(row => {
    let name = row.querySelector('.resource-search').value.trim();
    let type = row.querySelector('.resource-type-dropdown').value;
    let total = +row.querySelector('.pages').value || 0;
    let rate = +row.querySelector('.rate-per-hour').value;
    let note = row.querySelector('.resource-note').value.trim();
    let tag = row.querySelector('.resource-tag').value.trim();
    let priority = row.querySelector('.priority-dropdown').value;
    let interval = +row.querySelector('.interval-dropdown').value;
    let noTotal = row.querySelector('.no-total-checkbox').checked;
    if (!name) return;
    if (!noTotal && !total) return; // require total unless noTotal
    plan.push({ name, type, total, rate, note, tag, priority, interval, noTotal });
  });
  let days = [];
  for (let dt = new Date(start); dt <= end; dt.setDate(dt.getDate() + 1)) {
    days.push(new Date(dt));
  }
  let schedule = [];
  plan.forEach(resource => {
    let index = 0;
    let left = resource.total;
    for (let d = 0; d < days.length; d += resource.interval) {
      let day = new Date(days[d]);
      let assign;
      if (resource.noTotal) {
        assign = hoursPerDay * resource.rate; // Rate per hour × hours per day (purely by daily workload)
      } else {
        assign = Math.min(resource.rate, left);
        left -= assign;
      }
      schedule.push({
        resource: resource.name,
        type: resource.type,
        tag: resource.tag,
        note: resource.note,
        priority: resource.priority,
        date: day.toISOString().slice(0,10),
        assign,
        index: ++index
      });
      if (!resource.noTotal && left <= 0) break;
    }
  });
  window._schedule = schedule;
  renderSchedule(schedule);
  showToast('Schedule created!', "#26994a");
});

function renderSchedule(schedule) {
  const list = document.getElementById('schedule-list');
  if (!schedule || schedule.length === 0) { list.innerHTML = "<div style='color:#bc2d2d;margin:18px;'>No schedule found. Fill the form above!</div>"; return; }
  let byDay = {};
  schedule.forEach(task => {
    if (!byDay[task.date]) byDay[task.date] = [];
    byDay[task.date].push(task);
  });
  let html = "";
  Object.keys(byDay).sort().forEach(date => {
    html += `<div class="schedule-day"><b>${date}</b>`;
    byDay[date].forEach((task, idx) => {
      html += `<div class="task-row">
          <input type="checkbox" class="progress-check" data-date="${date}" data-idx="${idx}">
          <span style="font-weight:600;">${task.resource}</span> 
          <span>[${task.assign} items]</span>
          <span style="color:#589;">${task.type}</span>
          <span style="color:${task.priority==='high'?'#d30':'#b97'}">${task.priority}</span>
          ${task.tag ? `<span style="color:#2562cf;">#${task.tag}</span>` : ""}
          ${task.note ? `<span class="notes">${task.note}</span>` : ""}
        </div>`;
    });
    html += "</div>";
  });
  list.innerHTML = html;
  Array.from(list.querySelectorAll('.progress-check')).forEach(chk => {
    chk.addEventListener('change', function(){
      chk.parentElement.style.opacity = chk.checked ? ".45" : "1";
    });
  });
}

function showToast(msg, color = "#2562cf") {
  const toast = document.getElementById("toast-notify");
  toast.textContent = msg;
  toast.style.background = color;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2100);
}

document.getElementById('reset-btn').onclick = function(){
  window._schedule = [];
  document.getElementById('schedule-list').innerHTML = "";
  showToast('Form/schedule cleared!',"#2562cf");
}

document.getElementById('backup-btn').onclick = function(){
  let json = JSON.stringify(window._schedule || [], null, 2);
  let blob = new Blob([json], {type:"application/json"});
  let url = window.URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url; a.download = "study_plan_backup.json";
  document.body.appendChild(a); a.click();
  setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); },100);
  showToast("Backup downloaded!");
};
document.getElementById('restore-btn').onclick = function(){
  document.getElementById('restore-file').click();
};
document.getElementById('restore-file').onchange = function(evt){
  let file = evt.target.files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = function(e){
    try{
      let obj = JSON.parse(e.target.result);
      window._schedule = obj;
      renderSchedule(window._schedule);
      showToast('Backup restored!', "#26994a");
    }catch(e){
      showToast('Backup file error!', "#bc2d2d");
    }
  };
  reader.readAsText(file);
};

document.getElementById('export-gcal-btn').onclick = function() {
  const schedule = window._schedule || [];
  if (!schedule.length) return showToast("No schedule to export!", "#bc2d2d");
  let ics = [
    "BEGIN:VCALENDAR",
    "VERSION:2.0",
    "PRODID:-//FMGE-NEETPG-SCHEDULER//EN"
  ];
  schedule.forEach((task, i) => {
    let dtstart = task.date.replace(/-/g, "");
    let dtendObj = new Date(task.date);
    dtendObj.setDate(dtendObj.getDate() + 1);
    let dtend = dtendObj.toISOString().slice(0,10).replace(/-/g, "");
    let uid = `fmgeschdlr-${task.date}-${i}`;
    let title = `${task.resource} [${task.assign} items]`;
    let desc = `Type: ${task.type}, Priority: ${task.priority}, Tag: ${task.tag}, Note: ${task.note || ""}`;
    ics.push("BEGIN:VEVENT");
    ics.push("UID:" + uid);
    ics.push("DTSTART;VALUE=DATE:" + dtstart);
    ics.push("DTEND;VALUE=DATE:" + dtend);
    ics.push("SUMMARY:" + title.replace(/[\r\n]+/g," "));
    ics.push("DESCRIPTION:" + desc.replace(/[\r\n]+/g," "));
    ics.push("END:VEVENT");
  });
  ics.push("END:VCALENDAR");
  let blob = new Blob([ics.join("\r\n")], {type:"text/calendar;charset=utf-8"});
  let url = window.URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url; a.download = "study_schedule.ics";
  document.body.appendChild(a); a.click();
  setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); },100);
  showToast("Calendar file exported!");
};

// GOOGLE CALENDAR API DIRECT INTEGRATION
const CLIENT_ID = "429008753359-8poumjqj6qeoqftffvpdir1t3t01jdhs.apps.googleusercontent.com";
const API_KEY = "AIzaSyCPzDOyBCs5eus_ZTjJJxJGgGNT-IrBLcI";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";
let gapiLoaded = false, tokenClient, gcalInit = false;

function gcalLoad() {
  return new Promise(res => {
    if (gapiLoaded) { res(); return; }
    gapi.load("client", () => {
      gapiLoaded = true;
      gapi.client.init({ apiKey: API_KEY }).then(res);
    });
  });
}

document.getElementById('gcal-direct-btn').onclick = async function() {
  if (!window._schedule || !window._schedule.length)
    return showToast("No schedule to push to Calendar!", "#bc2d2d");

  if (!gcalInit) {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: async (tokenResponse) => {
        await gcalLoad();
        await createCalendarEvents(window._schedule, tokenResponse.access_token);
      }
    });
    gcalInit = true;
  }
  tokenClient.requestAccessToken();
};

async function createCalendarEvents(schedule, accessToken) {
  for (let task of schedule) {
    let endObj = new Date(task.date);
    endObj.setDate(endObj.getDate() + 1);
    let event = {
      summary: `${task.resource} [${task.assign} items]`,
      description: `Type: ${task.type}, Priority: ${task.priority}, Tag: ${task.tag}, Note: ${task.note || ""}`,
      start: { date: task.date },
      end: { date: endObj.toISOString().slice(0,10) }
    };
    try {
      await gapi.client.calendar.events.insert({
        calendarId: 'primary',
        resource: event
      });
    } catch (err) {
      showToast('Error creating event: ' + (err.message || err.result.error.message), '#bc2d2d');
      return;
    }
  }
  showToast('All events added to your Google Calendar!', "#26994a");
}
</script>
</body>
</html>

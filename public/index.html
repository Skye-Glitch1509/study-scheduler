<!DOCTYPE html>
<html lang="en">
<head>
  <title>Study Scheduler</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,600,700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.3/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: 'Inter', Arial, sans-serif; background: #f7fafc; color: #232c40; margin:0; }
    .dashboard-layout{display:flex;flex-direction:row;gap:22px;}
    .sidebar-tabnav{min-width:120px;background:#e5eaf1;padding:15px 10px 5px 10px; border-radius:13px;box-shadow:0 1px 6px #23262f19;display:flex;flex-direction:column;gap:10px;}
    .sidebar-tabnav button{background:none;color:#2562cf;border:none;margin:8px 0;padding:7px 11px;font-weight:600;font-size:1.03em;border-radius:7px;cursor:pointer;transition:background .14s;}
    .sidebar-tabnav button.active,
    .sidebar-tabnav button:focus{background:#2562cf;color:#fff;}
    .section-panel{flex:1;padding:0;min-width:240px;}
    #calendar-view{max-width:800px;margin:auto;}
    #chart-view{max-width:410px;margin:auto;}
    #gantt-view{max-width:720px;margin:auto;}
    @media (max-width:900px){
      .dashboard-layout{flex-direction:column;}
      .sidebar-tabnav{flex-direction:row;min-width:0;gap:7px;}
      #calendar-view,#gantt-view{max-width:99vw;}
    }
    .app-header { display: flex; align-items:center; justify-content:space-between; margin:12px 0 9px 0;}
    #darkmode-btn { border:none; background: #e5eaf1; color: #2562cf; width:38px; height:38px; font-size:23px;
      border-radius:50%; cursor:pointer; margin-left:13px;margin-bottom:2px;}
    .card{background:#fff;box-shadow:0 2px 14px #23262f10; border-radius:16px; border:1px solid #e2e8f0;padding:13px 20px 10px 17px;margin-bottom:12px;}
    .card-row{display:flex;flex-wrap:wrap;gap:12px;align-items:center; margin-bottom:7px;}
    .card-row label{font-weight:500;margin-right:7px;}
    .draggable-item{ background:#fff; box-shadow:0 2px 14px #23262f10; border-radius:9px; border:1.4px solid #e2e8f0; margin-bottom:13px; padding:12px 8px; display:flex; align-items:center; transition:background .2s,box-shadow .15s; position:relative; touch-action:pan-y; user-select:none;}
    .priority-high { border-left:6px solid #fa3939;}
    .priority-medium { border-left:6px solid #fabf3a;}
    .priority-low { border-left:6px solid #7ed957;}
    .priority-label{font-weight:700;font-size:.99em;display:inline-block;margin-right:8px;}
    .priority-label.high { color:#fa3939;}
    .priority-label.medium { color:#fabf3a;}
    .priority-label.low { color:#7ed957;}
    .draggable-item .del-btn { position:absolute;right:15px;top:15px;color:#bc2d2d;background:none;border:none;cursor:pointer;font-size:1.3em;z-index:2;}
    .no-total-checkbox {margin-left: 4px;}
    .no-total-label {margin-left: 8px; font-size: 0.98em; color: #2562cf;}
    @media (max-width:900px){.card-row{flex-direction:column;align-items:stretch;gap:7px;}.app-header{flex-direction:column;gap:8px;}}
    @media (max-width:500px){.card{border-radius:8px;padding:8px 6px 5px 6px;}.draggable-item{padding:6px;}label,.priority-label{font-size:.97em;}h1{font-size:1.2em;}.app-header{padding-left:3px;}button,input[type="button"]{padding:12px 6px;}}
    @media print { body > *:not(#schedule) { display: none !important; } #schedule { display: block !important; margin: 0 !important; } #schedule ul { margin: 0 !important; } #schedule h2 { margin-top: 0 !important; } }
  </style>
</head>
<body>
<div class="app-header">
  <h1>Study Scheduler</h1>
  <button id="darkmode-btn" aria-label="Toggle dark mode">üåô</button>
</div>
<div class="dashboard-layout">
  <nav class="sidebar-tabnav" aria-label="Main navigation">
    <button id="nav-list" class="active">List</button>
    <button id="nav-calendar">Calendar</button>
    <button id="nav-gantt">Gantt</button>
    <button id="nav-analytics">Analytics</button>
  </nav>
  <main id="main-panels">
    <section id="list-view" class="section-panel">
      <form id="study-form">
        <div class="card card-row">
          <label>Study hours per day: <input type="number" id="study-hours-per-day" min="1" max="24" value="3" style="width:72px;"></label>
        </div>
        <div id="resource-list">
          <div class="card card-row resource-row">
            <label>Resource: <input type="text" class="resource" required></label>
            <label class="resource-pages-label">
              Pages: <input type="number" class="pages" required style="width:70px;">
            </label>
            <label>Type:
              <select class="resource-type-dropdown">
                <option value="book">üìö Book</option>
                <option value="qbank">‚ùì QBank</option>
                <option value="flashcards">üÉè Flashcards</option>
                <option value="video">üì∫ Video</option>
                <option value="other">üìÑ Other</option>
              </select>
            </label>
            <label>
              Rate per hour: <input type="number" class="rate-per-hour" min="1" value="10" style="width:70px;">
              <span class="rate-type-label">pages/hr</span>
            </label>
            <label>
              <input type="checkbox" class="no-total-checkbox">
              <span class="no-total-label">No total/end (repeat rate every eligible day)</span>
            </label>
            <label>
              Priority:
              <select class="priority-dropdown">
                <option value="high">High ‚≠ê</option>
                <option value="medium" selected>Medium</option>
                <option value="low">Low</option>
              </select>
            </label>
            <label>Tag: <input type="text" class="resource-tag" placeholder="Tag" style="width:90px;"></label>
            <label>Note: <input type="text" class="resource-note" placeholder="Note" style="width:120px;"></label>
            <label>
              Interval:
              <select class="interval-dropdown" style="width:87px;">
                <option value="1">Every day</option>
                <option value="2">Every other day</option>
                <option value="3">Every 3rd day</option>
                <option value="7">Every week</option>
              </select>
            </label>
            <button type="button" class="remove-btn" style="display:none;">‚úñ</button>
          </div>
        </div>
        <button type="button" id="add-resource-btn">Add Resource</button>
        <br>
        <div class="card card-row weekday-checkboxes">
          <label><input type="checkbox" class="weekday" value="0" checked> Sun</label>
          <label><input type="checkbox" class="weekday" value="1" checked> Mon</label>
          <label><input type="checkbox" class="weekday" value="2" checked> Tue</label>
          <label><input type="checkbox" class="weekday" value="3" checked> Wed</label>
          <label><input type="checkbox" class="weekday" value="4" checked> Thu</label>
          <label><input type="checkbox" class="weekday" value="5" checked> Fri</label>
          <label><input type="checkbox" class="weekday" value="6" checked> Sat</label>
        </div>
        <div class="card card-row" id="rest-days-container">
          <b>Rest/Off Dates:</b>
          <div id="holiday-list" style="margin-left:10px;">
            <div class="holiday-input-row">
              <input type="date" class="holiday-date">
              <button type="button" class="remove-holiday-btn" style="display:none;">‚úñ</button>
            </div>
          </div>
          <button type="button" id="add-holiday-btn">Add Off Date</button>
        </div>
        <div class="card card-row" id="review-days-container">
          <b>Periodic Review:</b>
          <label>
            Every
            <select id="review-dropdown">
              <option value="0">None</option>
              <option value="7">7th day</option>
              <option value="6">6th day</option>
              <option value="5">5th day</option>
              <option value="4">4th day</option>
              <option value="3">3rd day</option>
              <option value="2">2nd day</option>
            </select>
            is Review/Rest
          </label>
        </div>
        <div class="card card-row">
          <label>Start Date: <input type="date" id="start-date" required></label>
          <label>End Date: <input type="date" id="end-date" required></label>
          <button type="submit" style="margin-left:14px;">Create Schedule</button>
        </div>
      </form>
      <div>
        <button type="button" id="download-csv-btn">Export CSV</button>
        <button type="button" id="download-ics-btn">Export Calendar (.ics)</button>
        <button type="button" id="download-pdf-btn">Print/PDF</button>
        <button type="button" id="backup-btn">Backup JSON</button>
        <button type="button" id="restore-btn">Restore JSON</button>
        <input type="file" id="restore-file" style="display:none;">
      </div>
      <div id="schedule"></div>
    </section>
    <section id="calendar-view" class="section-panel" style="display:none;"></section>
    <section id="gantt-view" class="section-panel" style="display:none;"></section>
    <section id="chart-view" class="section-panel" style="display:none;">
      <canvas id="analytics-chart" style="max-width:380px;"></canvas>
      <div id="analytics-summary" style="max-width:380px;margin:14px 0 0 0;"></div>
    </section>
  </main>
</div>
<script>
const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)');
function autoSetDarkMode() {
  const useDark = darkModeQuery.matches || localStorage.getItem('darkOverride') === '1';
  document.body.classList.toggle('dark', useDark);
  document.getElementById('darkmode-btn').innerText = useDark ? "üåû" : "üåô";
}
darkModeQuery.addEventListener('change', autoSetDarkMode);
autoSetDarkMode();
document.getElementById('darkmode-btn').onclick = function() {
  const wasDark = document.body.classList.contains('dark');
  localStorage.setItem('darkOverride', wasDark ? '0' : '1');
  autoSetDarkMode();
};

function showPanel(panel){
  Array.from(document.querySelectorAll('.section-panel')).forEach(sec=>sec.style.display='none');
  document.getElementById(`${panel}-view`).style.display='';
  Array.from(document.querySelectorAll('.sidebar-tabnav button')).forEach(btn=>btn.classList.remove('active'));
  document.getElementById(`nav-${panel}`).classList.add('active');
}
document.getElementById('nav-list').onclick=()=>showPanel('list');
document.getElementById('nav-calendar').onclick=()=>{showPanel('calendar');renderAllViews();};
document.getElementById('nav-gantt').onclick=()=>{showPanel('gantt');renderAllViews();};
document.getElementById('nav-analytics').onclick=()=>{showPanel('chart');renderAnalyticsChart();};

const resourceTypeIcons = {book:"üìö", qbank:"‚ùì", flashcards:"üÉè", video:"üì∫", other:"üìÑ"};
const resourceTypeLabels = {book:"Book",qbank:"QBank",flashcards:"Flashcards",video:"Video",other:"Other"};
const rateTypeLabels = {book:"pages/hr",qbank:"questions/hr",flashcards:"cards/hr",video:"videos/hr",other:"items/hr"};
const pagesLabels = {book:"Pages: ",qbank:"Questions: ",flashcards:"Cards: ",video:"Videos: ",other:"Items: "};

function updateRateTypeLabels() {
  document.querySelectorAll('.resource-row').forEach(row => {
    const typeSel = row.querySelector('.resource-type-dropdown');
    const rateLabel = row.querySelector('.rate-type-label');
    const pagesLabel = row.querySelector('.resource-pages-label');
    const noTotal = row.querySelector('.no-total-checkbox');
    function disablePagesInput(disabled) {
      row.querySelector('.pages').disabled = !!disabled;
      if (disabled) {
        row.querySelector('.pages').value = '';
      }
    }
    if (noTotal) {
      noTotal.onchange = function() {
        disablePagesInput(noTotal.checked);
      };
      disablePagesInput(noTotal.checked);
    }
    if (typeSel && rateLabel) rateLabel.textContent = rateTypeLabels[typeSel.value] || "items/hr";
    if (typeSel && pagesLabel) pagesLabel.childNodes[0].textContent = pagesLabels[typeSel.value] || "Items: ";
    typeSel.addEventListener('change', function() {
      rateLabel.textContent = rateTypeLabels[this.value] || "items/hr";
      if (pagesLabel) pagesLabel.childNodes[0].textContent = pagesLabels[this.value] || "Items: ";
    });
  });
}
function addResourceRow(resourceVal="", pagesVal="", typeVal="book", tagVal="", noteVal="", intervalVal="1", rateVal="10", priorityVal="medium", noTotal=false) {
  const resourceList = document.getElementById('resource-list');
  const newRow = resourceList.firstElementChild.cloneNode(true);
  newRow.querySelector('.resource').value = resourceVal || "";
  newRow.querySelector('.pages').value = pagesVal || "";
  newRow.querySelector('.resource-type-dropdown').value = typeVal;
  newRow.querySelector('.resource-tag').value = tagVal;
  newRow.querySelector('.resource-note').value = noteVal;
  newRow.querySelector('.interval-dropdown').value = intervalVal;
  newRow.querySelector('.rate-per-hour').value = rateVal || 10;
  newRow.querySelector('.priority-dropdown').value = priorityVal;
  newRow.querySelector('.no-total-checkbox').checked = noTotal;
  updateRateTypeLabels();
  const removeBtn = newRow.querySelector('.remove-btn');
  removeBtn.style.display = 'inline';
  removeBtn.addEventListener('click', function() { newRow.remove(); updateRateTypeLabels(); });
  resourceList.appendChild(newRow);
  updateRateTypeLabels();
}
document.getElementById('add-resource-btn').addEventListener('click', function() { addResourceRow(); updateRateTypeLabels(); });
updateRateTypeLabels();
document.getElementById('add-holiday-btn').onclick = function() {
  const holidayList = document.getElementById('holiday-list');
  const newRow = holidayList.firstElementChild.cloneNode(true);
  newRow.querySelector('.holiday-date').value = "";
  const removeBtn = newRow.querySelector('.remove-holiday-btn');
  removeBtn.style.display = 'inline';
  removeBtn.onclick = function() { newRow.remove(); };
  holidayList.appendChild(newRow);
};
Array.from(document.querySelectorAll('.remove-holiday-btn')).forEach(btn => {
  btn.onclick = function() { if (btn.closest('.holiday-input-row').parentNode.childElementCount > 1) btn.closest('.holiday-input-row').remove(); };
});
function getSelectedWeekdays() {
  return Array.from(document.querySelectorAll('.weekday')).filter(cb => cb.checked).map(cb => parseInt(cb.value));
}
function getSkipDates() {
  return Array.from(document.querySelectorAll('.holiday-date')).map(input => input.value).filter(val => val);
}
function getRestDays(startDate, endDate, reviewDayInterval) {
  let restDays = getSkipDates();
  if (reviewDayInterval >= 2) {
    let dt = new Date(startDate), i=0;
    while (dt <= endDate) { i++; if (i % reviewDayInterval === 0) restDays.push(dt.toISOString().slice(0,10)); dt.setDate(dt.getDate() + 1);}
  }
  return Array.from(new Set(restDays));
}
function getScheduleDays(startDate, endDate, weekDays, skipDatesArr) {
  const days = []; let dt = new Date(startDate);
  while (dt <= endDate) { const dStr = dt.toISOString().slice(0,10);
    if (weekDays.includes(dt.getDay()) && !skipDatesArr.includes(dStr)) { days.push(new Date(dt)); }
    dt.setDate(dt.getDate() + 1); }
  return days;
}
document.getElementById('study-form').addEventListener('submit',function(event){
  event.preventDefault();
  const resourceNames = Array.from(document.querySelectorAll('.resource')).map(input=>input.value);
  const pageCountsRaw = Array.from(document.querySelectorAll('.pages')).map(input=>input.value);
  const noTotalArr = Array.from(document.querySelectorAll('.no-total-checkbox')).map(cb=>cb.checked);
  const pageCounts = pageCountsRaw.map((v, idx) => noTotalArr[idx] ? null : parseInt(v, 10));
  const intervals = Array.from(document.querySelectorAll('.interval-dropdown')).map(select=>parseInt(select.value,10));
  const resourceTypes = Array.from(document.querySelectorAll('.resource-type-dropdown')).map(e=>e.value);
  const resourceTags = Array.from(document.querySelectorAll('.resource-tag')).map(e=>e.value);
  const resourceNotes = Array.from(document.querySelectorAll('.resource-note')).map(e=>e.value);
  const ratePerHour = Array.from(document.querySelectorAll('.rate-per-hour')).map(input=>parseInt(input.value,10) || 1);
  const priorities = Array.from(document.querySelectorAll('.priority-dropdown')).map(sel=>sel.value);
  const studyHoursPerDay = parseInt(document.getElementById('study-hours-per-day').value, 10) || 1;
  const startDate = new Date(document.getElementById('start-date').value);
  const endDate = new Date(document.getElementById('end-date').value);
  const weekDays = getSelectedWeekdays();
  const reviewDayInterval = parseInt(document.getElementById('review-dropdown').value, 10) || 0;
  const skipDatesArr = getRestDays(startDate, endDate, reviewDayInterval);
  const scheduleDays = getScheduleDays(startDate, endDate, weekDays, skipDatesArr);
  const planId = `${startDate.toISOString().slice(0,10)}_${endDate.toISOString().slice(0,10)}_${resourceNames.join('_')}_${weekDays.join('-')}_${skipDatesArr.join('-')}_${intervals.join('-')}`;
  window.lastPlanConfig = {
    resourceNames, pageCounts, pageCountsRaw, noTotalArr,
    intervals, startDate, endDate, planId, scheduleDays,
    resourceTypes, resourceTags, resourceNotes, ratePerHour,
    priorities, studyHoursPerDay
  };
  window.lastScheduleDays = scheduleDays;
  const progress = loadProgress()[planId]||{};
  renderSchedule(window.lastPlanConfig,progress,false,resourceTypes,skipDatesArr);
  renderAllViews();
});

function renderSchedule(planConfig, progress, rebalance = false, resourceTypesArg=null, skipDatesArr=null) {
  const {
    resourceNames, pageCounts, noTotalArr, intervals,
    startDate, endDate, planId, scheduleDays,
    resourceTypes, resourceTags, resourceNotes, ratePerHour,
    priorities, studyHoursPerDay
  } = planConfig;
  const numDays = scheduleDays.length;
  let notes = loadNotes()[planId] || {};
  let types = resourceTypesArg || resourceTypes || [];
  let tags = resourceTags || Array(resourceNames.length).fill("");
  let resNotes = resourceNotes || Array(resourceNames.length).fill("");
  let prios = priorities || Array(resourceNames.length).fill("medium");
  let skipArr = skipDatesArr || getSkipDates();
  let daysIdxArrList = resourceNames.map((r, idx)=>
    noTotalArr[idx] ? Array(numDays).fill(0).map((_,i)=>i)
      : (()=>{let arr=[];for(let i=0;i<numDays;i+=intervals[idx])arr.push(i);return arr;})()
  );
  let tasksArr = [];
  let reviewRestMap = {}; skipArr.forEach(dateStr => reviewRestMap[dateStr]=true);

  for(let i=0;i<numDays;i++){
    const day = scheduleDays[i];
    const dStr = day.toISOString().slice(0,10);
    if (reviewRestMap[dStr]) {
      tasksArr.push({
        date: day.toLocaleDateString(), sortDate: day.getTime(),
        resource: "Rest/Review Day", type: "", tag:"", pages: "-", interval: "", id: `review_${dStr}_${i}`,
        checked: "", note: "", priority:"medium", rawType:""
      });
      continue;
    }
    let timeLeft = studyHoursPerDay;
    resourceNames.forEach((resource,idx)=>{
      let arr=daysIdxArrList[idx];
      if(arr.includes(i)){
        let assignCount = noTotalArr[idx]
          ? ratePerHour[idx] // for infinite resources: assign the rate per day (the user input)
          : Math.ceil(pageCounts[idx]/arr.length); // for bounded resources
        let timeNeeded = assignCount / ratePerHour[idx];
        timeLeft -= timeNeeded;
        const taskId=`${planId}_${resource}_${i}`;
        const noteVal=notes[taskId]?notes[taskId]:'';
        const isChecked=progress[taskId]?"checked":"";
        tasksArr.push({
          date: day.toLocaleDateString(), sortDate: day.getTime(),
          resource: `${resourceTypeIcons[types[idx]]} ${resource}`, type: resourceTypeLabels[types[idx]], rawType: types[idx], tag:tags[idx],
          pages: assignCount, interval:intervals[idx], id:taskId,
          checked: isChecked, note: noteVal, resNote: resNotes[idx], priority: prios[idx], isInfinite: noTotalArr[idx]
        });
      }
    });
  }
  // Sort by: date, then priority high>medium>low
  const prioSortOrder = {high:0, medium:1, low:2};
  const groupedByDate = {};
  tasksArr.forEach(task => {
    if (!groupedByDate[task.date]) groupedByDate[task.date] = [];
    groupedByDate[task.date].push(task);
  });
  let allDates = Object.keys(groupedByDate).sort((a,b)=> new Date(a) - new Date(b));
  let displayArr = [];
  allDates.forEach(d => {
    let arr = groupedByDate[d];
    displayArr = displayArr.concat(arr.sort((a,b)=> (prioSortOrder[a.priority||"medium"] - prioSortOrder[b.priority||"medium"])));
  });
  let scheduleHtml;
  if (displayArr.length === 0) {
    scheduleHtml = '<h2>Study Schedule</h2><div style="color:#bc2d2d;margin:24px;">No tasks scheduled. Please add resources and create a schedule.</div>';
  } else {
    scheduleHtml='<h2>Study Schedule</h2><ul id="draggable-list">';
    displayArr.forEach((item,idx)=>{
      if (item.resource === "Rest/Review Day") {
        scheduleHtml += `<li class="draggable-item priority-medium" tabindex="0">
          <b>${item.date}</b>: <span style="color:#d88427;font-weight:bold;">Rest / Review Day</span>
        </li>`;
        return;
      }
      const prioClass = item.priority==='high' ? 'priority-high' : item.priority==='low' ? 'priority-low' : 'priority-medium';
      const prioLabel = `<span class="priority-label ${item.priority}">${item.priority==='high'?'‚≠ê High':item.priority==='medium'?'Medium':'Low'}</span>`;
      scheduleHtml += `<li class="draggable-item ${prioClass}" draggable="true" tabindex="0" role="listitem" data-tid="${item.id}">
        <span class="drag-indicator" aria-label="Drag" tabindex="-1">&#x2630;</span>
        <input type="checkbox" class="progress-checkbox" data-task="${item.id}" ${item.checked} aria-label="Mark complete">
        ${prioLabel}
        <b>${item.date}</b>: ${item.resource}
        <span style="color:#222;font-size:13px;">(${item.type})</span>
        <span style="color:#297bb7;font-size:13px;"> [${item.tag}]</span>,
        Assigned: <b>${item.pages}</b>
        <span style="font-size:13px;">(${rateTypeLabels[item.rawType]})</span>
        <span style="color:#777; font-style:italic;">${item.resNote}</span>
        ${item.isInfinite ? "<span style='color:#555;font-size:0.95em;font-style:italic;'>(infinite)</span>" : ""}
        <input type="text" class="note-input" data-task-note="${item.id}" placeholder="Add note..." value="${item.note}" aria-label="Task note">
        <button class="del-btn" aria-label="Delete task" tabindex="-1">‚úñ</button>
      </li>`;
    });
    scheduleHtml+='</ul>';
  }
  document.getElementById('schedule').innerHTML=scheduleHtml;

  setTimeout(()=>{
    let items=Array.from(document.querySelectorAll('.draggable-item'));
    items.forEach((item, idx)=>{
      let touchstartX=0, touchendX=0;
      item.addEventListener('dragstart',(e)=>{item.classList.add("dragging");});
      item.addEventListener('dragend',(e)=>{item.classList.remove("dragging");});
      item.addEventListener('dragover',e=>{e.preventDefault(); item.classList.add('drop-target');});
      item.addEventListener('dragleave',e=>{item.classList.remove('drop-target');});
      item.addEventListener('drop',(e)=>{
        e.preventDefault(); item.classList.remove('drop-target');
        let dragging=document.querySelector('.draggable-item.dragging');
        if (dragging && dragging!==item) {
          item.parentNode.insertBefore(dragging,item.nextSibling);
        }
      });
      item.addEventListener('touchstart',(e)=>{touchstartX=e.changedTouches[0].screenX;});
      item.addEventListener('touchend',(e)=>{
        touchendX=e.changedTouches[0].screenX;
        if (touchendX<touchstartX-70) { item.remove(); }
        else if (touchendX>touchstartX+70) { let cb=item.querySelector('.progress-checkbox'); if(cb){cb.checked=true;cb.dispatchEvent(new Event('change'));}}
      });
      item.addEventListener('keydown',function(e){
        if(e.key==='Delete'){item.remove();}
        if(e.key==='ArrowDown'&&items[idx+1])items[idx+1].focus();
        if(e.key==='ArrowUp'&&items[idx-1])items[idx-1].focus();
      });
      item.querySelector('.del-btn').onclick=function(){item.remove();};
    });
    document.querySelectorAll('.progress-checkbox').forEach(cb=>{
      cb.addEventListener('change',function(){
        let saveData=loadProgress();let saveNotes=loadNotes();let manualOrder=loadManualOrder();
        saveData[planConfig.planId]=saveData[planConfig.planId]||{};
        saveData[planConfig.planId][this.dataset.task]=this.checked?true:false;
        saveProgress(saveData,saveNotes,manualOrder);
        renderSchedule(planConfig,saveData[planConfig.planId],rebalance,types,skipArr);
        renderAllViews();
      });
    });
    document.querySelectorAll('.note-input').forEach(noteInput=>{
      noteInput.addEventListener('change',function(){
        let saveData=loadProgress();let saveNotes=loadNotes();let manualOrder=loadManualOrder();
        saveNotes[planConfig.planId]=saveNotes[planConfig.planId]||{};
        saveNotes[planConfig.planId][this.dataset.taskNote]=this.value;
        saveProgress(saveData,saveNotes,manualOrder);
      });
    });
  },30);
}
function extractScheduleArrFromModel() {
  let arr=[];
  if(window.lastPlanConfig){
    let plan=window.lastPlanConfig;
    let progress=loadProgress()[plan.planId]||{};
    (plan.scheduleDays||[]).forEach((dayObj,i)=>{
      plan.resourceNames.forEach((name,ri)=>{
        arr.push({
          resource: name,
          date: dayObj.toLocaleDateString(),
          dateObj: new Date(dayObj),
          pages: plan.noTotalArr && plan.noTotalArr[ri]
            ? plan.ratePerHour[ri]
            : plan.pageCounts && plan.pageCounts[ri] ? plan.pageCounts[ri] : 0,
          priority: plan.priorities ? plan.priorities[ri] : 'medium',
          checked: progress[`${plan.planId}_${name}_${i}`]||false,
          isInfinite: plan.noTotalArr ? plan.noTotalArr[ri] : false
        });
      });
    });
  }
  window.currentScheduleArr = arr;
  return arr;
}
function renderAllViews() {
  let schedArr = extractScheduleArrFromModel();
  renderCalendar(schedArr);
  renderGantt(schedArr);
  window.currentScheduleArr = schedArr;
}
function renderCalendar(schedule) {
  const calDiv = document.getElementById('calendar-view');
  calDiv.innerHTML = '<div id="study-calendar"></div>';
  if (!schedule || schedule.length === 0) {
    calDiv.innerHTML += '<div style="margin:28px;color:#bc2d2d;">No scheduled tasks found. Create a study plan first!</div>';
    return;
  }
  let events = [];
  (schedule||[]).forEach(task=>{
    if(task.resource && !task.checked) {
      events.push({
        title: task.resource + (task.isInfinite ? " (‚àû)" : "") + ' (' + task.pages + ')',
        start: task.dateObj,
        allDay: true,
        color: task.priority==='high'?'#fa3939':task.priority==='medium'?'#fabf3a':'#7ed957'
      });
    }
  });
  let calendar = new FullCalendar.Calendar(calDiv.querySelector('#study-calendar'),{
    initialView:'dayGridMonth',
    events:events,
    height:530,
    editable:true,
    eventClick:function(info){
      alert(info.event.title + " on " + info.event.startStr);
    }
  });
  calendar.render();
}
function renderGantt(schedule) {
  const container = document.getElementById('gantt-view');
  if (!schedule || schedule.length === 0) {
    container.innerHTML = '<h2>Gantt Timeline</h2><div style="margin:28px;color:#bc2d2d;">No scheduled tasks found. Create a study plan first!</div>';
    return;
  }
  let html = '<h2>Gantt Timeline</h2><div style="max-width:650px;">';
  let tasks = (schedule||[]).filter(x=>x.resource && !x.checked);
  let resources = Array.from(new Set(tasks.map(x=>x.resource)));
  resources.forEach(resource=>{
    let barTasks = tasks.filter(x=>x.resource===resource);
    html+=`<div><b>${resource}</b><div style="display:flex;">`;
    barTasks.forEach(t=>{
      html+=`<div style="flex:1;padding:3px 0;margin:0 2px;background:${t.priority==='high'?'#fa3939':t.priority==='medium'?'#fabf3a':'#7ed957'};" title="${t.date}">${t.date}${t.isInfinite?" ‚àû":""}</div>`;
    });
    html+='</div></div>';
  });
  html += '</div>';
  container.innerHTML = html;
}
function renderAnalyticsChart() {
  let chartCanvas = document.getElementById('analytics-chart');
  let schedule = window.currentScheduleArr||[];
  if (!schedule || schedule.length === 0) {
    document.getElementById('analytics-summary').innerHTML = '<div style="color:#bc2d2d;margin:18px;">No scheduled tasks found. Create a study plan first!</div>';
    chartCanvas.style.display = "none";
    return;
  }
  chartCanvas.style.display = "";
  let dataByResource = {};
  schedule.forEach(task=>{
    let res = task.resource||'Other';
    dataByResource[res] = (dataByResource[res]||0) + (task.pages||1);
  });
  let resources=Object.keys(dataByResource);
  let values=resources.map(r=>dataByResource[r]);
  let chartData = {labels:resources, datasets:[{label:'Assigned',data:values,backgroundColor:'#2562cf'}]};
  chartCanvas.height=230;
  new Chart(chartCanvas, {type:'bar',data:chartData,options:{responsive:true}});
  let summary = resources.map((r,i)=>`<b>${r}</b>: ${values[i]} assigned`).join('<br>');
  document.getElementById('analytics-summary').innerHTML = summary;
}
document.getElementById('download-csv-btn').onclick = function() {
  if (!window.lastPlanConfig) { alert('No schedule to export!'); return; }
  let csv = 'Priority,Date,Resource,Type,Tag,Assigned,Note\n';
  const progress = loadProgress()[window.lastPlanConfig.planId] || {};
  document.querySelectorAll('.draggable-item').forEach(item => {
    const tid = item.getAttribute('data-tid');
    if (!tid || progress[tid]) return;
    const prio = item.querySelector('.priority-label') ? item.querySelector('.priority-label').innerText.trim() : '';
    const date = item.querySelector('b') ? item.querySelector('b').innerText.trim() : '';
    const resource = item.querySelector('span:nth-of-type(2)') ? item.querySelector('span:nth-of-type(2)').innerText.trim() : '';
    const type = item.querySelector('span:nth-of-type(3)') ? item.querySelector('span:nth-of-type(3)').innerText.replace(/[\(\)]/g,'').trim() : '';
    const tag = item.querySelector('span:nth-of-type(4)') ? item.querySelector('span:nth-of-type(4)').innerText.replace(/[\[\]]/g,'').trim() : '';
    const assigned = (item.innerText.match(/Assigned: (\d+)/)||[])[1] || '';
    const note = item.querySelector('input[type=text]') ? item.querySelector('input[type=text]').value.replace(/,/g,';') : '';
    csv += [prio, date, resource, type, tag, assigned, note].map(x=>`"${x}"`).join(',')+'\n';
  });
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'study_schedule.csv';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);}, 100);
};

document.getElementById('download-ics-btn').onclick = function() {
  if (!window.lastPlanConfig) { alert('No schedule to export!'); return; }
  const incompleteTasks = [];
  const progress = loadProgress()[window.lastPlanConfig.planId] || {};
  const scheduleDiv = document.getElementById('schedule');
  scheduleDiv.querySelectorAll('.draggable-item').forEach(item => {
    const tid = item.getAttribute('data-tid');
    if (!tid || progress[tid]) return;
    const label = item.textContent.replace(/\s+/g, ' ').trim();
    const dateMatch = label.match(/^\d{1,2}\/\d{1,2}\/\d{2,4}/);
    const dateStr = dateMatch ? dateMatch[0] : null;
    if (!dateStr) return;
    let [month,day,year] = dateStr.split('/').map(Number);
    if (year < 100) year += 2000;
    incompleteTasks.push(`BEGIN:VEVENT
SUMMARY:${label.replace(/^\d{1,2}\/\d{1,2}\/\d{2,4}:\s*/, '')}
DTSTART;VALUE=DATE:${year}${String(month).padStart(2,'0')}${String(day).padStart(2,'0')}
DTEND;VALUE=DATE:${year}${String(month).padStart(2,'0')}${String(day+1).padStart(2,'0')}
END:VEVENT`);
  });
  const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
${incompleteTasks.join('\n')}
END:VCALENDAR`;
  const blob = new Blob([icsContent], { type: 'text/calendar' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'study_schedule.ics';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);}, 100);
};

document.getElementById('download-pdf-btn').onclick = function() {
  const scheduleDiv = document.getElementById('schedule');
  if (!scheduleDiv || scheduleDiv.innerText.trim().length === 0 || /no tasks scheduled/i.test(scheduleDiv.innerHTML)) {
    alert("No schedule found to export. Please create a schedule first.");
    return;
  }
  window.print();
};

document.getElementById('backup-btn').onclick = function() {
  if (!window.lastPlanConfig) { alert('No schedule to export!'); return; }
  let json = JSON.stringify({
    planConfig: window.lastPlanConfig || {},
    progress: window.lastProgressCache || {},
    notes: window.lastNotesCache || {},
    manualOrder: window.lastOrderCache || {}
  }, null, 2);
  let blob = new Blob([json], {type:"application/json"});
  let url = window.URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url; a.download = "study_plan_backup.json";
  document.body.appendChild(a); a.click();
  setTimeout(()=>{document.body.removeChild(a);window.URL.revokeObjectURL(url);},100);
};

document.getElementById('restore-btn').onclick = function() { document.getElementById('restore-file').click(); };
document.getElementById('restore-file').onchange = function(evt) {
  let file = evt.target.files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = function(e) {
    try {
      let obj = JSON.parse(e.target.result);
      if (!obj.planConfig) throw new Error("Missing planConfig");
      window.lastPlanConfig = obj.planConfig;
      window.lastProgressCache = obj.progress || {};
      window.lastNotesCache = obj.notes || {};
      window.lastOrderCache = obj.manualOrder || {};
      renderSchedule(window.lastPlanConfig, window.lastProgressCache, false);
      renderAllViews();
      alert('Backup restored!');
    } catch(e) {
      alert('Could not parse backup. File may be corrupted or from an incompatible/old version.');
    }
  };
  reader.readAsText(file);
};
function saveProgress(progress, notes, manualOrder) {
  localStorage.setItem('studyProgress', JSON.stringify(progress));
  localStorage.setItem('studyNotes', JSON.stringify(notes));
  localStorage.setItem('studyManualOrder', JSON.stringify(manualOrder));
}
function loadProgress() { return JSON.parse(localStorage.getItem('studyProgress') || '{}'); }
function loadNotes() { return JSON.parse(localStorage.getItem('studyNotes') || '{}'); }
function loadManualOrder() { return JSON.parse(localStorage.getItem('studyManualOrder') || '{}'); }
</script>
</body>
</html>

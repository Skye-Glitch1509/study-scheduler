<!DOCTYPE html>
<html>
<head>
  <title>Study Scheduler</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .resource-row { margin-bottom: 7px; }
    ul { list-style-type: none; padding-left: 0; }
    li { margin-bottom: 7px; }
    .progress-checkbox { margin-right: 8px; cursor:pointer;}
    #add-resource-btn, #rebalance-btn, #download-csv-btn, #download-ics-btn, #cloud-save-btn, #cloud-load-btn, #create-new-btn { margin-top: 8px; margin-bottom: 10px; }
    #plan-id-display {margin-top: 10px; font-size: 15px; color: #444; background: #f6f6f6; border-radius: 8px; padding: 10px;}
    #progress-bar-container {
      width: 100%; max-width: 500px; height: 24px;
      background: #eee; border-radius: 12px; overflow: hidden; margin-bottom:20px; margin-top: 24px;
    }
    #progress-bar {
      width: 0%; height: 100%; background: #4CAF50;
      transition: width 0.3s;
    }
    #progress-label {
      margin-top: 3px; font-weight: bold;
    }
    .weekday-checkboxes label {
      margin-right: 12px;
    }
    .interval-label {
      display: inline-block;
      margin-left: 12px;
    }
    .interval-dropdown {
      width: 160px;
      margin-left: 6px;
    }
    .note-input {
      margin-left: 8px; width: 160px; margin-right: 4px;
    }
    #holiday-list { margin-bottom: 10px; }
    .holiday-input-row { margin-bottom: 4px; }
    .drag-indicator {
      cursor: grab;
      margin-right: 6px;
      font-weight: bold;
      color: #888;
    }
    .dragging {
      opacity: 0.5;
    }
    .drop-target {
      background: #fffae6 !important;
    }
  </style>
</head>
<body>
  <button type="button" id="cloud-load-btn" style="display:inline;">Load plan from cloud</button>
  <button type="button" id="create-new-btn" style="display:none;">Create new schedule instead</button>
  <h1>Study Scheduler</h1>
  <div id="plan-id-display" style="display:none"></div>
  <form id="study-form" style="display:block;">
    <div id="resource-list">
      <div class="resource-row">
        <label>Book/Resource Name: <input type="text" class="resource" required></label>
        <label>Total Pages: <input type="number" class="pages" required></label>
        <label class="interval-label">
          Interval:
          <select class="interval-dropdown">
            <option value="1">Every day</option>
            <option value="2">Every other day</option>
            <option value="3">Every 3rd day</option>
            <option value="7">Every week</option>
          </select>
        </label>
        <button type="button" class="remove-btn" style="display:none;">Remove</button>
      </div>
    </div>
    <button type="button" id="add-resource-btn">Add Another Resource</button>
    <br>
    <div class="weekday-checkboxes">
      <label><input type="checkbox" class="weekday" value="0" checked> Sun</label>
      <label><input type="checkbox" class="weekday" value="1" checked> Mon</label>
      <label><input type="checkbox" class="weekday" value="2" checked> Tue</label>
      <label><input type="checkbox" class="weekday" value="3" checked> Wed</label>
      <label><input type="checkbox" class="weekday" value="4" checked> Thu</label>
      <label><input type="checkbox" class="weekday" value="5" checked> Fri</label>
      <label><input type="checkbox" class="weekday" value="6" checked> Sat</label>
    </div>
    <br>
    <div>
      <b>Skip these dates (holidays):</b>
      <div id="holiday-list">
        <div class="holiday-input-row">
          <input type="date" class="holiday-date">
          <button type="button" class="remove-holiday-btn" style="display:none;">Remove</button>
        </div>
      </div>
      <button type="button" id="add-holiday-btn">Add Another Holiday/Skip Date</button>
    </div>
    <br>
    <label>Start Date: <input type="date" id="start-date" required></label><br>
    <label>End Date: <input type="date" id="end-date" required></label><br>
    <button type="submit">Create Schedule</button>
  </form>
  <button type="button" id="cloud-save-btn" style="display:none;">Save plan to cloud</button>
  <button type="button" id="download-csv-btn" style="display:none;">Download CSV</button>
  <button type="button" id="download-ics-btn" style="display:none;">Download Calendar (.ics)</button>
  <div id="progress-bar-container" style="display:none;">
    <div id="progress-bar"></div>
  </div>
  <div id="progress-label"></div>
  <button type="button" id="rebalance-btn" style="display:none;">Rebalance Schedule</button>
  <div id="schedule"></div>
<script>
var CLOUD_API_URL = "https://script.google.com/macros/s/AKfycbyw3nDaDxpHi14sT7IwRwxUxQ6S2SDt9N7zXftwdt7l51Pfe6yiRg-YrpnjuLaS_12J2w/exec";
var USER_ID = "default";

// All JS logic (unchanged otherwise)
function cloudSave(planConfig, progress, notes, manualOrder) {
  var payload = {
    id: planConfig.planId,
    user: USER_ID,
    savedPlan: JSON.stringify({
      planConfig, progress, notes, manualOrder
    })
  };
  fetch(CLOUD_API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  }).then(res => res.json()).then(data => {
    alert("Saved to cloud!");
  }).catch(err => {
    alert("Cloud save failed!");
  });
}
function cloudLoad(planId, callback) {
  fetch(CLOUD_API_URL + "?action=load&planid=" + encodeURIComponent(planId))
    .then(res => res.text())
    .then(text => {
      let data;
      try {data = JSON.parse(text);} catch(e){data={};}
      callback(data);
    }).catch(err=>{
      alert("Cloud load failed!");
    });
}
function saveProgress(progress, notes, manualOrder) {
  localStorage.setItem('studyProgress', JSON.stringify(progress));
  localStorage.setItem('studyNotes', JSON.stringify(notes));
  localStorage.setItem('studyManualOrder', JSON.stringify(manualOrder));
}
function loadProgress() { return JSON.parse(localStorage.getItem('studyProgress') || '{}'); }
function loadNotes() { return JSON.parse(localStorage.getItem('studyNotes') || '{}'); }
function loadManualOrder() { return JSON.parse(localStorage.getItem('studyManualOrder') || '{}'); }
let lastPlanConfig = null, lastBoxCount = { total: 0, done: 0 }, lastScheduleDays = [], lastProgressCache = {}, lastNotesCache = {}, lastOrderCache = {};

document.getElementById('add-resource-btn').addEventListener('click', function() {
  const resourceList = document.getElementById('resource-list');
  const newRow = resourceList.firstElementChild.cloneNode(true);
  newRow.querySelectorAll('input').forEach(input => input.value = '');
  newRow.querySelector('.interval-dropdown').selectedIndex = 0;
  const removeBtn = newRow.querySelector('.remove-btn');
  removeBtn.style.display = 'inline';
  removeBtn.addEventListener('click', function() { newRow.remove(); });
  resourceList.appendChild(newRow);
});
document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', function(e){
  if(document.querySelectorAll('.resource-row').length > 1) {
    e.target.closest('.resource-row').remove();
  }
}));
document.getElementById('add-holiday-btn').addEventListener('click', function() {
  const holidayList = document.getElementById('holiday-list');
  const newRow = holidayList.firstElementChild.cloneNode(true);
  newRow.querySelector('input').value = '';
  const removeBtn = newRow.querySelector('.remove-holiday-btn');
  removeBtn.style.display = 'inline';
  removeBtn.addEventListener('click', function() { newRow.remove(); });
  holidayList.appendChild(newRow);
});
document.querySelectorAll('.remove-holiday-btn').forEach(btn =>
  btn.addEventListener('click', function(e){
    e.target.closest('.holiday-input-row').remove();
  })
);
function countDaysDone(progress, planId, resource, daysIdxArr) {
  return Object.keys(progress)
    .filter(k => {
      return k.startsWith(`${planId}_${resource}_`) && progress[k] &&
        (!daysIdxArr || daysIdxArr.includes(parseInt(k.split('_').pop())));
    }).length;
}
function updateProgressBar() {
  if (lastBoxCount.total === 0) {
    document.getElementById('progress-bar-container').style.display = "none";
    document.getElementById('progress-label').innerText = "";
    return;
  }
  const percent = Math.round((lastBoxCount.done / lastBoxCount.total) * 100);
  document.getElementById('progress-bar').style.width = percent + "%";
  document.getElementById('progress-bar-container').style.display = "block";
  document.getElementById('progress-label').innerText = `Progress: ${lastBoxCount.done} / ${lastBoxCount.total} (${percent}%)`;
}
function getSelectedWeekdays() { return Array.from(document.querySelectorAll('.weekday')).filter(cb => cb.checked).map(cb => parseInt(cb.value)); }
function getSkipDates() { return Array.from(document.querySelectorAll('.holiday-date')).map(input => input.value).filter(val => val); }
function getScheduleDays(startDate, endDate, weekDays, skipDates) {
  const days = []; let dt = new Date(startDate);
  while (dt <= endDate) { const dStr = dt.toISOString().slice(0,10);
    if (weekDays.includes(dt.getDay()) && !skipDates.includes(dStr)) { days.push(new Date(dt)); }
    dt.setDate(dt.getDate() + 1); }
  return days;
}
// --- Calendar download ---
function pad(n){return n<10?"0"+n:n;}
function datetoCal(dt) {
  return [dt.getUTCFullYear(),pad(dt.getUTCMonth()+1),pad(dt.getUTCDate())].join('');
}
function escapeICS(str){return String(str||'').replace(/([,;])/g,"\\$1").replace(/\n/g,"\\n");}
function downloadICS(planConfig, notes, manualOrder) {
  if (!planConfig) return;
  const { resourceNames, pageCounts, intervals, planId, scheduleDays } = planConfig;
  let manual=manualOrder&&manualOrder[planId]?manualOrder[planId]:null;
  let numDays=scheduleDays.length;
  let daysIdxArrList=resourceNames.map((r,idx)=>{let arr=[];for(let i=0;i<numDays;i+=intervals[idx])arr.push(i);return arr;});
  let components=[`BEGIN:VCALENDAR`,`VERSION:2.0`,`CALSCALE:GREGORIAN`,`PRODID:-//User-Generated Study Scheduler//EN`];
  let tasksArr=[];
  for(let i=0;i<numDays;i++){
    const day=scheduleDays[i];
    resourceNames.forEach((resource,idx)=>{
      let arr=daysIdxArrList[idx];
      if(arr.includes(i)){
        let pagesPerDay=Math.ceil(pageCounts[idx]/arr.length);
        let arrPos=arr.indexOf(i);
        let startPage=arrPos*pagesPerDay+1;
        let endPage=Math.min((arrPos+1)*pagesPerDay,pageCounts[idx]);
        let intervalText="Every day";
        if(intervals[idx]===2)intervalText="Every other day";
        else if(intervals[idx]===3)intervalText="Every 3rd day";
        else if(intervals[idx]===7)intervalText="Every week";
        else if(intervals[idx]>1)intervalText=`Every ${intervals[idx]} days`;
        const taskId=`${planId}_${resource}_${i}`;
        const noteVal=notes[planId]&&notes[planId][taskId]?notes[planId][taskId]:'';
        tasksArr.push({
          date: new Date(day),
          summary: `${resource} (${intervalText})`,
          description: `Read pages ${startPage}-${endPage}`+(noteVal?`\nNote: ${noteVal}`:''),
          id: taskId
        });
      }
    });
  }
  if(manual){tasksArr.sort((a,b)=>manual.indexOf(a.id)-manual.indexOf(b.id));}
  tasksArr.forEach(t=>{
    let dtstamp=(new Date()).toISOString().replace(/[-:.]/g,"").split("T")[0]+"T000000Z";
    let dtstart=datetoCal(t.date);
    let dtend=datetoCal(new Date(t.date.getTime()+86400000));
    components.push(
      "BEGIN:VEVENT",
      "UID:"+t.id+"@studyplanner",
      "DTSTAMP:"+dtstamp,
      "DTSTART;VALUE=DATE:"+dtstart,
      "DTEND;VALUE=DATE:"+dtend,
      "SUMMARY:"+escapeICS(t.summary),
      "DESCRIPTION:"+escapeICS(t.description),
      "END:VEVENT"
    );
  });
  components.push(`END:VCALENDAR`);
  let icsText=components.join("\r\n");
  let blob=new Blob([icsText],{type:"text/calendar"});
  let url=window.URL.createObjectURL(blob);
  let link=document.createElement("a");
  link.href=url;link.download="study_schedule.ics";
  document.body.appendChild(link);link.click();
  setTimeout(()=>{document.body.removeChild(link);window.URL.revokeObjectURL(url);},100);
}
// --- CSV download ---
function downloadCSV(planConfig, progress, notes, manualOrder) {
  if (!planConfig) return;
  const { resourceNames, pageCounts, intervals, startDate, endDate, planId, scheduleDays } = planConfig;
  let displayOrder = manualOrder && manualOrder[planId] ? manualOrder[planId] : null;
  let numDays = scheduleDays.length; let csvRows = [["Date","Resource","Pages","Interval","Done","Note"]];
  let daysIdxArrList = resourceNames.map((r, idx) => {let arr=[];for(let i=0;i<numDays;i+=intervals[idx])arr.push(i);return arr;});
  let tasksArr = [];
  for (let i=0;i<numDays;i++) {
    const day = scheduleDays[i];
    resourceNames.forEach((resource, idx) => {
      let arr=daysIdxArrList[idx];
      if(arr.includes(i)){
        let pagesPerDay=Math.ceil(pageCounts[idx]/arr.length);
        let arrPos=arr.indexOf(i);
        let startPage=arrPos*pagesPerDay+1;let endPage=Math.min((arrPos+1)*pagesPerDay,pageCounts[idx]);
        let intervalText="Every day";
        if(intervals[idx]===2)intervalText="Every other day";
        else if(intervals[idx]===3)intervalText="Every 3rd day";
        else if(intervals[idx]===7)intervalText="Every week";
        else if(intervals[idx]>1)intervalText=`Every ${intervals[idx]} days`;
        const taskId=`${planId}_${resource}_${i}`;
        const isComplete=progress[taskId]?"Yes":"No";
        const noteVal=notes[taskId]?notes[taskId].replace(/"/g,'""'):"";
        tasksArr.push({
          date: day.toLocaleDateString(),
          resource,
          pages: `${startPage}-${endPage}`,
          interval: intervalText,
          done: isComplete,
          note: `"${noteVal}"`,
          id: taskId
        });
      }
    });
  }
  if(displayOrder){tasksArr.sort((a,b)=>displayOrder.indexOf(a.id)-displayOrder.indexOf(b.id));}
  tasksArr.forEach(t=>{csvRows.push([t.date,t.resource,t.pages,t.interval,t.done,t.note]);});
  const csvText=csvRows.map(r=>r.join(",")).join("\r\n");
  const blob=new Blob([csvText],{type:"text/csv"});
  const url=window.URL.createObjectURL(blob);
  const link=document.createElement("a");
  link.href=url;link.download="study_schedule.csv";
  document.body.appendChild(link);link.click();
  setTimeout(()=>{document.body.removeChild(link);window.URL.revokeObjectURL(url);},100);
}

// Main event handler for plan load (prompt always)
document.getElementById('cloud-load-btn').addEventListener('click', function() {
  let defaultId = localStorage.getItem("lastPlanId") || "";
  let planId = prompt("Enter plan ID to load from cloud:", defaultId);
  if (!planId) return;
  cloudLoad(planId, function(result) {
    if (result && result.planConfig) {
      showLoadedSchedule(result);
      localStorage.setItem("lastPlanId", planId);
      document.getElementById('plan-id-display').innerText = 'Current Plan ID: ' + planId;
      document.getElementById('plan-id-display').style.display = 'block';
    } else {
      alert("No cloud plan found for this ID!");
    }
  });
});

document.getElementById('create-new-btn').addEventListener('click', function() {
  document.getElementById('schedule').innerHTML = '';
  document.getElementById('study-form').style.display = 'block';
  document.getElementById('create-new-btn').style.display = 'none';
  document.getElementById('plan-id-display').style.display = 'none';
});

document.getElementById('cloud-save-btn').addEventListener('click', function() {
  cloudSave(lastPlanConfig, lastProgressCache, lastNotesCache, lastOrderCache);
});
document.getElementById('download-csv-btn').addEventListener('click',function(){
  downloadCSV(lastPlanConfig,lastProgressCache,lastNotesCache,lastOrderCache);
});
document.getElementById('download-ics-btn').addEventListener('click',function(){
  downloadICS(lastPlanConfig,loadNotes(),loadManualOrder());
});
document.getElementById('rebalance-btn').addEventListener('click',function(){
  if(!lastPlanConfig)return;
  const progress=loadProgress()[lastPlanConfig.planId]||{};
  renderSchedule(lastPlanConfig,progress,true);
});

document.getElementById('study-form').addEventListener('submit',function(event){
  event.preventDefault();
  const resourceNames=Array.from(document.querySelectorAll('.resource')).map(input=>input.value);
  const pageCounts=Array.from(document.querySelectorAll('.pages')).map(input=>parseInt(input.value,10));
  const intervals=Array.from(document.querySelectorAll('.interval-dropdown')).map(select=>parseInt(select.value,10));
  const startDate=new Date(document.getElementById('start-date').value);
  const endDate=new Date(document.getElementById('end-date').value);
  const weekDays=getSelectedWeekdays();
  const skipDates=getSkipDates();
  const scheduleDays=getScheduleDays(startDate,endDate,weekDays,skipDates);
  const planId=`${startDate.toISOString().slice(0,10)}_${endDate.toISOString().slice(0,10)}_${resourceNames.join('_')}_${weekDays.join('-')}_${skipDates.join('-')}_${intervals.join('-')}`;
  lastPlanConfig={resourceNames,pageCounts,intervals,startDate,endDate,planId,scheduleDays};
  lastScheduleDays=scheduleDays;
  const progress=loadProgress()[planId]||{};
  localStorage.setItem("lastPlanId", planId);
  document.getElementById('plan-id-display').innerText = 'Current Plan ID: ' + planId;
  document.getElementById('plan-id-display').style.display = 'block';
  renderSchedule(lastPlanConfig,progress,false);
});

function showLoadedSchedule(result) {
  document.getElementById('study-form').style.display = 'none';
  document.getElementById('schedule').innerHTML = '';
  renderSchedule(result.planConfig, result.progress || {}, false);
  document.getElementById('create-new-btn').style.display = 'inline';
}

function renderSchedule(planConfig, progress, rebalance = false) {
  const { resourceNames, pageCounts, intervals, startDate, endDate, planId, scheduleDays } = planConfig;
  const numDays = scheduleDays.length;
  let remainingPages = pageCounts.slice();
  let pagesDone = resourceNames.map((res, idx) => 0);
  let totalBoxCount = 0, doneBoxCount = 0;
  let notes = loadNotes()[planId] || {};
  let manualOrder = loadManualOrder();
  let daysIdxArrList = resourceNames.map((r, idx)=>{let arr=[];for(let i=0;i<numDays;i+=intervals[idx])arr.push(i);return arr;});
  let tasksArr = [];
  for(let i=0;i<numDays;i++){
    const day=scheduleDays[i];
    resourceNames.forEach((resource,idx)=>{
      let pagesTotal=rebalance?remainingPages[idx]:pageCounts[idx];
      let arr=daysIdxArrList[idx];
      if(arr.includes(i)){
        let undoneDays=arr.length-(rebalance?countDaysDone(progress,planId,resource,arr):0);
        let pagesPerDay=Math.ceil(pagesTotal/(rebalance?undoneDays:arr.length));
        let arrPos=arr.indexOf(i);
        let startPage=rebalance?pagesDone[idx]+arrPos*pagesPerDay+1:arrPos*pagesPerDay+1;
        let endPage=Math.min(rebalance?pagesDone[idx]+(arrPos+1)*pagesPerDay:(arrPos+1)*pagesPerDay,pageCounts[idx]);
        const taskId=`${planId}_${resource}_${i}`;
        let intervalText="Every day";
        if(intervals[idx]===2)intervalText="Every other day";
        else if(intervals[idx]===3)intervalText="Every 3rd day";
        else if(intervals[idx]===7)intervalText="Every week";
        else if(intervals[idx]>1)intervalText=`Every ${intervals[idx]} days`;
        const noteVal=notes[taskId]?notes[taskId]:'';
        tasksArr.push({
          date: day.toLocaleDateString(),
          sortDate: day.getTime(),
          resource,
          pages: `${startPage}-${endPage}`,
          interval: intervalText,
          id: taskId,
          checked: progress[taskId]?"checked":"",
          note: noteVal
        });
      }
    });
  }
  if(manualOrder&&manualOrder[planId]){tasksArr.sort((a,b)=>manualOrder[planId].indexOf(a.id)-manualOrder[planId].indexOf(b.id));}else{tasksArr.sort((a,b)=>a.sortDate-b.sortDate);}
  let scheduleHtml='<h2>Study Schedule</h2><ul id="draggable-list">';
  tasksArr.forEach((item,idx)=>{
    scheduleHtml+=`<li class="draggable-item" draggable="true" data-tid="${item.id}">
      <span class="drag-indicator">&#x2630;</span>
      <input type="checkbox" class="progress-checkbox" data-task="${item.id}" ${item.checked}>
      <b>${item.date}</b>: ${item.resource}, Pages ${item.pages} (${item.interval})
      <input type="text" class="note-input" data-task-note="${item.id}" placeholder="Add note..." value="${item.note}">
    </li>`;
    totalBoxCount++;if(item.checked)doneBoxCount++;
  });
  scheduleHtml+='</ul>';
  document.getElementById('schedule').innerHTML=scheduleHtml;
  document.getElementById('rebalance-btn').style.display='inline';
  document.getElementById('download-csv-btn').style.display='inline';
  document.getElementById('download-ics-btn').style.display='inline';
  document.getElementById('cloud-save-btn').style.display='inline';
  lastBoxCount={total:totalBoxCount,done:doneBoxCount};
  updateProgressBar();
  lastProgressCache=progress;
  lastNotesCache=notes;
  lastOrderCache=manualOrder;
  let draggedIdx=null,dragOverIdx=null;
  const list=document.getElementById("draggable-list");
  const items=list?Array.from(list.querySelectorAll('.draggable-item')):[];
  items.forEach((item,idx)=>{
    item.addEventListener("dragstart",(e)=>{draggedIdx=idx;item.classList.add("dragging");});
    item.addEventListener("dragend",(e)=>{
      item.classList.remove("dragging");
      if(typeof draggedIdx==="number"&&typeof dragOverIdx==="number"&&draggedIdx!==dragOverIdx){
        let idList=items.map(i=>i.getAttribute("data-tid"));
        const movingId=idList[draggedIdx];idList.splice(draggedIdx,1);idList.splice(dragOverIdx,0,movingId);
        let manualOrder=loadManualOrder();manualOrder[planConfig.planId]=idList;
        saveProgress(loadProgress(),loadNotes(),manualOrder);
        renderSchedule(planConfig,progress,rebalance);
      }
      draggedIdx=null;dragOverIdx=null;
    });
    item.addEventListener("dragover",(e)=>{
      e.preventDefault();dragOverIdx=items.indexOf(item);
      items.forEach(i=>i.classList.remove("drop-target"));
      item.classList.add("drop-target");
    });
    item.addEventListener("dragleave",(e)=>{item.classList.remove("drop-target");});
  });
  document.querySelectorAll('.progress-checkbox').forEach(cb=>{
    cb.addEventListener('change',function(){
      let saveData=loadProgress();let saveNotes=loadNotes();let manualOrder=loadManualOrder();
      saveData[planConfig.planId]=saveData[planConfig.planId]||{};
      saveData[planConfig.planId][this.dataset.task]=this.checked?true:false;
      saveProgress(saveData,saveNotes,manualOrder);
      renderSchedule(planConfig,saveData[planConfig.planId],rebalance);
    });
  });
  document.querySelectorAll('.note-input').forEach(noteInput=>{
    noteInput.addEventListener('change',function(){
      let saveData=loadProgress();let saveNotes=loadNotes();let manualOrder=loadManualOrder();
      saveNotes[planConfig.planId]=saveNotes[planConfig.planId]||{};
      saveNotes[planConfig.planId][this.dataset.taskNote]=this.value;
      saveProgress(saveData,saveNotes(),manualOrder);
    });
  });
}
</script>
</body>
</html>

<!-- Save as public/index.html, replacing previous version -->
<!DOCTYPE html>
<html>
<head>
  <title>Study Scheduler</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .resource-row { margin-bottom: 7px; }
    ul { list-style-type: none; padding-left: 0; }
    li { margin-bottom: 7px; }
    .progress-checkbox { margin-right: 8px; cursor:pointer;}
    #add-resource-btn, #bulk-add-btn, #rebalance-btn, #adv-rebalance-btn, #download-csv-btn, #download-ics-btn, #download-pdf-btn, #backup-btn, #restore-btn { margin-top: 8px; margin-bottom: 10px; }
    #progress-bar-container {
      width: 100%; max-width: 500px; height: 24px;
      background: #eee; border-radius: 12px; overflow: hidden; margin-bottom:20px; margin-top: 24px;
    }
    #progress-bar { width: 0%; height: 100%; background: #4CAF50; transition: width 0.3s;}
    #progress-label { margin-top: 3px; font-weight: bold; }
    .weekday-checkboxes label { margin-right: 12px; }
    .interval-label { display: inline-block; margin-left: 12px; }
    .interval-dropdown { width: 110px; margin-left: 6px; }
    .resource-type-dropdown { width: 90px; margin-left: 8px; }
    .resource-tag, .resource-note { width:95px; margin-left:8px; }
    .note-input { margin-left: 8px; width: 160px; margin-right: 4px; }
    #holiday-list { margin-bottom: 10px; }
    .holiday-input-row { margin-bottom: 4px; }
    .drag-indicator { cursor: grab; margin-right: 6px; font-weight: bold; color: #888; }
    .dragging { opacity: 0.5;}
    .drop-target { background: #fffae6 !important; }
    #bulk-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.16); z-index:1500; }
    #bulk-modal-inner { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: #fff; padding:36px; border-radius:24px; box-shadow:0 0 32px #1113; min-width:320px; min-height:250px; }
    #rest-days-container, #review-days-container { margin-bottom:8px;}
    #review-dropdown { width:80px; margin-left:5px;}
    #review-days-container { margin-top:4px;}
    #load-graph-container { margin-top: 20px; margin-bottom:24px;}
    #load-graph-bar { display:flex; align-items:end; height:70px; gap:2px;}
    #load-graph-bar>div { background:#9ec0ff; min-width:6px; border-radius:3px 3px 0 0; transition:height 0.2s; }
    #load-graph-legend {font-size:12px;color:#444;margin-top:2px;}
    #template-strip { background: #f7fafc; border-radius:12px; padding:6px 15px; margin:10px 0 14px 0;}
    #template-strip button { margin-right:10px; border-radius:6px; }
  </style>
</head>
<body>
  <h1>Study Scheduler</h1>
  <div id="template-strip">
    <b>Templates:</b>
    <button onclick="applyTemplate('exam')">Exam Cram</button>
    <button onclick="applyTemplate('balanced')">Balanced Review</button>
    <button onclick="applyTemplate('weekend')">Weekend Only</button>
  </div>
  <form id="study-form" style="display:block;">
    <div id="resource-list">
      <div class="resource-row">
        <label>Book/Resource Name: <input type="text" class="resource" required></label>
        <label>Total Pages: <input type="number" class="pages" required></label>
        <label>Type: 
          <select class="resource-type-dropdown">
            <option value="book">üìö Book</option>
            <option value="qbank">‚ùì QBank</option>
            <option value="flashcards">üÉè Flashcards</option>
            <option value="video">üì∫ Video</option>
            <option value="other">üìÑ Other</option>
          </select>
        </label>
        <label>Tag: <input type="text" class="resource-tag" placeholder="Tag"></label>
        <label>Note: <input type="text" class="resource-note" placeholder="Resource note"></label>
        <label class="interval-label">
          Interval:
          <select class="interval-dropdown">
            <option value="1">Every day</option>
            <option value="2">Every other day</option>
            <option value="3">Every 3rd day</option>
            <option value="7">Every week</option>
          </select>
        </label>
        <button type="button" class="remove-btn" style="display:none;">Remove</button>
      </div>
    </div>
    <button type="button" id="add-resource-btn">Add Another Resource</button>
    <button type="button" id="bulk-add-btn">Bulk Add Resources</button>
    <br>
    <div class="weekday-checkboxes">
      <label><input type="checkbox" class="weekday" value="0" checked> Sun</label>
      <label><input type="checkbox" class="weekday" value="1" checked> Mon</label>
      <label><input type="checkbox" class="weekday" value="2" checked> Tue</label>
      <label><input type="checkbox" class="weekday" value="3" checked> Wed</label>
      <label><input type="checkbox" class="weekday" value="4" checked> Thu</label>
      <label><input type="checkbox" class="weekday" value="5" checked> Fri</label>
      <label><input type="checkbox" class="weekday" value="6" checked> Sat</label>
    </div>
    <br>
    <div id="rest-days-container">
      <b>Off/Rest Days (specific dates):</b>
      <div id="holiday-list">
        <div class="holiday-input-row">
          <input type="date" class="holiday-date">
          <button type="button" class="remove-holiday-btn" style="display:none;">Remove</button>
        </div>
      </div>
      <button type="button" id="add-holiday-btn">Add Rest/Off Date</button>
    </div>
    <div id="review-days-container">
      <b>Periodic Review/Off:</b>
      <label>
        Every
        <select id="review-dropdown">
          <option value="0">None</option>
          <option value="7">7th day</option>
          <option value="6">6th day</option>
          <option value="5">5th day</option>
          <option value="4">4th day</option>
          <option value="3">3rd day</option>
          <option value="2">2nd day</option>
        </select>
        is Review/Rest
      </label>
      <span style="font-size:14px;margin-left:10px;">(will insert rest/review milestone)</span>
    </div>
    <br>
    <label>Start Date: <input type="date" id="start-date" required></label><br>
    <label>End Date: <input type="date" id="end-date" required></label><br>
    <button type="submit">Create Schedule</button>
  </form>
  <div>
    <button type="button" id="download-csv-btn" style="display:none;">Download CSV</button>
    <button type="button" id="download-ics-btn" style="display:none;">Download Calendar (.ics)</button>
    <button type="button" id="download-pdf-btn" style="display:none;">Print / Export PDF</button>
    <button type="button" id="backup-btn" style="display:none;">Backup / Export JSON</button>
    <button type="button" id="restore-btn" style="display:inline;">Import JSON</button>
    <input type="file" id="restore-file" style="display:none;">
  </div>
  <div id="progress-bar-container" style="display:none;">
    <div id="progress-bar"></div>
  </div>
  <div id="progress-label"></div>
  <button type="button" id="rebalance-btn" style="display:none;">Rebalance Schedule</button>
  <button type="button" id="adv-rebalance-btn" style="display:none;">Advanced Rebalance (smooth workload)</button>
  <div id="load-graph-container" style="display:none;">
    <b>Daily Load Graph</b>
    <div id="load-graph-bar"></div>
    <div id="load-graph-legend"></div>
  </div>
  <div id="schedule"></div>
  <!-- Bulk Add Modal -->
  <div id="bulk-modal">
    <div id="bulk-modal-inner">
      <h2>Bulk Add Resources</h2>
      <div>
        <b>Paste resource names (one per line):</b><br>
        <textarea id="bulk-resource-input" rows="10" style="width:98%"></textarea>
      </div>
      <br>
      <label>Type:
        <select id="bulk-type-dropdown">
          <option value="book">üìö Book</option>
          <option value="qbank">‚ùì QBank</option>
          <option value="flashcards">üÉè Flashcards</option>
          <option value="video">üì∫ Video</option>
          <option value="other">üìÑ Other</option>
        </select>
      </label>
      <label>Tag: <input type="text" id="bulk-tag-input" placeholder="Tag"></label>
      <label>Note: <input type="text" id="bulk-note-input" placeholder="Note"></label>
      <label>
        Pages/Items per resource:
        <input type="number" id="bulk-pages-input" min="1" value="10" style="width:60px;">
      </label>
      <br><br>
      <button id="bulk-confirm-btn">Add Resources</button>
      <button id="bulk-cancel-btn">Cancel</button>
    </div>
  </div>
<script>
const resourceTypeIcons = {
  book: "üìö", qbank: "‚ùì", flashcards: "üÉè", video: "üì∫", other: "üìÑ"
};
const resourceTypeLabels = {
  book: "Book", qbank: "QBank", flashcards: "Flashcards", video: "Video", other: "Other"
};
const studyTemplates = {
  exam: {
    resources: [["Boards Book", 800, "book", "high yield", ""], ["QBank Full", 2400, "qbank", "", "Timed only"]],
    intervals: [1,1], types: ["book","qbank"], tags:["high yield",""], notes:["","Timed only"],
    weekdays: [0,1,2,3,4,5,6], startDays:0, reviewDay:7
  },
  balanced: {
    resources: [["Textbook",500,"book","",""],["Flash Deck",150,"flashcards","",""],["Review Videos",40,"video","",""]],
    intervals:[2,2,3], types:["book","flashcards","video"], tags:["","",""], notes:["","",""],
    weekdays:[1,2,3,4,5], startDays:0, reviewDay:7
  },
  weekend: {
    resources: [["MCQ Practice",300,"qbank","",""],["Weekly Review",36,"video","",""]],
    intervals: [7,7], types:["qbank","video"], tags:["",""], notes:["",""], weekdays:[6,0], startDays:0, reviewDay:0
  }
};
// Local save/load
function saveProgress(progress, notes, manualOrder) {
  localStorage.setItem('studyProgress', JSON.stringify(progress));
  localStorage.setItem('studyNotes', JSON.stringify(notes));
  localStorage.setItem('studyManualOrder', JSON.stringify(manualOrder));
}
function loadProgress() { return JSON.parse(localStorage.getItem('studyProgress') || '{}'); }
function loadNotes() { return JSON.parse(localStorage.getItem('studyNotes') || '{}'); }
function loadManualOrder() { return JSON.parse(localStorage.getItem('studyManualOrder') || '{}'); }

let lastPlanConfig = null, lastBoxCount = { total: 0, done: 0 }, lastScheduleDays = [],
    lastProgressCache = {}, lastNotesCache = {}, lastOrderCache = {};

document.getElementById('add-resource-btn').addEventListener('click', function() {
  addResourceRow();
});
function addResourceRow(resourceVal="", pagesVal="", typeVal="book", tagVal="", noteVal="", intervalVal="1") {
  const resourceList = document.getElementById('resource-list');
  const newRow = resourceList.firstElementChild.cloneNode(true);
  newRow.querySelector('.resource').value = resourceVal || "";
  newRow.querySelector('.pages').value = pagesVal || "";
  newRow.querySelector('.resource-type-dropdown').value = typeVal;
  newRow.querySelector('.resource-tag').value = tagVal;
  newRow.querySelector('.resource-note').value = noteVal;
  newRow.querySelector('.interval-dropdown').value = intervalVal;
  const removeBtn = newRow.querySelector('.remove-btn');
  removeBtn.style.display = 'inline';
  removeBtn.addEventListener('click', function() { newRow.remove(); });
  resourceList.appendChild(newRow);
}
document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', function(e){
  if(document.querySelectorAll('.resource-row').length > 1) {
    e.target.closest('.resource-row').remove();
  }
}));
document.getElementById('add-holiday-btn').addEventListener('click', function() {
  const holidayList = document.getElementById('holiday-list');
  const newRow = holidayList.firstElementChild.cloneNode(true);
  newRow.querySelector('input').value = '';
  const removeBtn = newRow.querySelector('.remove-holiday-btn');
  removeBtn.style.display = 'inline';
  removeBtn.addEventListener('click', function() { newRow.remove(); });
  holidayList.appendChild(newRow);
});
document.querySelectorAll('.remove-holiday-btn').forEach(btn =>
  btn.addEventListener('click', function(e){ e.target.closest('.holiday-input-row').remove(); })
);
// --- Bulk Modal Logic ---
document.getElementById('bulk-add-btn').addEventListener('click', function() {
  document.getElementById('bulk-resource-input').value = '';
  document.getElementById('bulk-modal').style.display = 'block';
});
document.getElementById('bulk-cancel-btn').onclick = function() {
  document.getElementById('bulk-modal').style.display = 'none';
};
document.getElementById('bulk-confirm-btn').onclick = function() {
  const lines = document.getElementById('bulk-resource-input').value.split('\n').map(x=>x.trim()).filter(x=>x);
  const bulkType = document.getElementById('bulk-type-dropdown').value;
  const bulkTag = document.getElementById('bulk-tag-input').value;
  const bulkNote = document.getElementById('bulk-note-input').value;
  const bulkPages = parseInt(document.getElementById('bulk-pages-input').value, 10) || 1;
  if (!lines.length) { alert("Paste at least one resource"); return; }
  lines.forEach(name=>{
    addResourceRow(name, bulkPages, bulkType, bulkTag, bulkNote, "1");
  });
  document.getElementById('bulk-modal').style.display = 'none';
};
// --- Other schedule helpers ---
function getSelectedWeekdays() { return Array.from(document.querySelectorAll('.weekday')).filter(cb => cb.checked).map(cb => parseInt(cb.value)); }
function getSkipDates() { return Array.from(document.querySelectorAll('.holiday-date')).map(input => input.value).filter(val => val); }
function getRestDays(startDate, endDate, reviewDayInterval) {
  let restDays = getSkipDates();
  if (reviewDayInterval >= 2) {
    let dt = new Date(startDate), i=0;
    while (dt <= endDate) { i++; if (i % reviewDayInterval === 0) restDays.push(dt.toISOString().slice(0,10)); dt.setDate(dt.getDate() + 1);}
  }
  return Array.from(new Set(restDays));
}
function getScheduleDays(startDate, endDate, weekDays, skipDatesArr) {
  const days = []; let dt = new Date(startDate);
  while (dt <= endDate) { const dStr = dt.toISOString().slice(0,10);
    if (weekDays.includes(dt.getDay()) && !skipDatesArr.includes(dStr)) { days.push(new Date(dt)); }
    dt.setDate(dt.getDate() + 1); }
  return days;
}

document.getElementById('backup-btn').onclick = function() {
  if (!lastPlanConfig) { alert('No plan to export!'); return; }
  let json = JSON.stringify({
    planConfig: lastPlanConfig,
    progress: lastProgressCache,
    notes: lastNotesCache,
    manualOrder: lastOrderCache
  });
  let blob=new Blob([json],{type:"application/json"});
  let url=window.URL.createObjectURL(blob);
  let link=document.createElement("a");
  link.href=url;link.download="study_plan_backup.json";
  document.body.appendChild(link);link.click();
  setTimeout(()=>{document.body.removeChild(link);window.URL.revokeObjectURL(url);},100);
};
document.getElementById('restore-btn').onclick = function() {
  document.getElementById('restore-file').click();
};
document.getElementById('restore-file').onchange = function(evt) {
  let file = evt.target.files[0];
  let reader = new FileReader();
  reader.onload = function(e) {
    try {
      let obj = JSON.parse(e.target.result);
      showLoadedSchedule(obj);
      alert('Backup restored!');
    } catch { alert('Could not parse backup.'); }
  };
  if(file)reader.readAsText(file);
};

document.getElementById('download-csv-btn').addEventListener('click',function(){
  let resourceTypes = Array.from(document.querySelectorAll('.resource-type-dropdown')).map(e=>e.value);
  let resourceTags = Array.from(document.querySelectorAll('.resource-tag')).map(e=>e.value);
  let resourceNotes = Array.from(document.querySelectorAll('.resource-note')).map(e=>e.value);
  downloadCSV(lastPlanConfig,lastProgressCache,lastNotesCache,lastOrderCache,resourceTypes,resourceTags,resourceNotes);
});
document.getElementById('download-ics-btn').addEventListener('click',function(){
  let resourceTypes = Array.from(document.querySelectorAll('.resource-type-dropdown')).map(e=>e.value);
  let resourceTags = Array.from(document.querySelectorAll('.resource-tag')).map(e=>e.value);
  let resourceNotes = Array.from(document.querySelectorAll('.resource-note')).map(e=>e.value);
  downloadICS(lastPlanConfig,loadNotes(),loadManualOrder(),resourceTypes,resourceTags,resourceNotes);
});
// PDF export (print)
document.getElementById('download-pdf-btn').onclick = function() {
  window.print();
};
// Templates support
function applyTemplate(which) {
  document.getElementById('resource-list').innerHTML = '';
  const tpl = studyTemplates[which];
  if (!tpl) return;
  tpl.resources.forEach((res, idx) => {
    addResourceRow(res[0], res[1], res[2], tpl.tags[idx], tpl.notes[idx], tpl.intervals[idx]);
  });
  document.querySelectorAll('.weekday').forEach(cb=>{ cb.checked = tpl.weekdays.includes(parseInt(cb.value)); });
  document.getElementById('review-dropdown').value = tpl.reviewDay;
}

// Algorithm: advanced rebalance to minimize workload variance
function advancedRebalance(planConfig, progress, callback) {
  const days = planConfig.scheduleDays.length;
  const tasksPerResource = planConfig.resourceNames.map((res,idx)=>{
    let arr=[];for(let i=0;i<days;i+=planConfig.intervals[idx])arr.push(i);
    let pagesPerDay=Math.ceil(planConfig.pageCounts[idx]/arr.length);
    return arr.map(d=>({
      ridx:idx, day:d, pages:pagesPerDay, type:planConfig.resourceTypes[idx],
      tag:planConfig.resourceTags[idx], note:planConfig.resourceNotes[idx], name:res
    }));
  });
  let allTasks = tasksPerResource.flat();
  // Initial assignment: map of day to tasks
  let assignments = Array.from({length:days}, ()=>[]);
  allTasks.forEach(task=>assignments[task.day].push(task));
  // Basic smoothing loop
  for(let iter=0;iter<10;iter++) {
    let dayLoads=assignments.map(day=>day.reduce((a,b)=>a+b.pages,0));
    let maxI=dayLoads.indexOf(Math.max(...dayLoads)), minI=dayLoads.indexOf(Math.min(...dayLoads));
    if(dayLoads[maxI]-dayLoads[minI]<=1)break;
    // Try to move a task from max to min if interval allows (not already assigned)
    let taskToMove=assignments[maxI].find(task=>
      !assignments[minI].some(t=>t.ridx===task.ridx)
    );
    if(taskToMove) {
      assignments[minI].push(taskToMove);
      assignments[maxI]=assignments[maxI].filter(x=>x!==taskToMove);
    } else break;
  }
  // Build new schedule: map back to resource arrays
  callback(assignments);
}

document.getElementById('adv-rebalance-btn').addEventListener('click', function(){
  if (!lastPlanConfig) return;
  advancedRebalance(lastPlanConfig, lastProgressCache, function(newAssignments){
    // Build scheduleDays as before
    // Build rendering, graph, etc
    let plan = lastPlanConfig;
    let scheduleHtml='<h2>Advanced Rebalanced Schedule</h2><ul id="draggable-list">';
    let workloadPerDay = [];
    for(let i=0;i<plan.scheduleDays.length;i++){
      let tasks = newAssignments[i];
      let day = plan.scheduleDays[i], dateStr=day.toLocaleDateString();
      scheduleHtml += `<li style="border-left:7px solid #bed7ff;margin-bottom:10px;">`;
      scheduleHtml += `<b>${dateStr}</b>: `;
      if (tasks.length===0) {
        scheduleHtml += `<span style="color:#d88427;font-weight:bold;">Rest / Review Day</span>`;
      } else {
        tasks.forEach(t=>{
          scheduleHtml += `<span>${resourceTypeIcons[t.type]} <b>${t.name}</b> [${t.tag}] (${t.pages} pgs/items) ` +
            (t.note ? `<span style="font-style:italic;color:#777;">${t.note}</span>`:"") + `</span> `;
        });
      }
      scheduleHtml += `</li>`;
      workloadPerDay[i] = tasks.reduce((a,b)=>a+b.pages,0);
    }
    scheduleHtml+='</ul>';
    document.getElementById('schedule').innerHTML=scheduleHtml;
    // Update graph
    let graphBar = document.getElementById('load-graph-bar');
    graphBar.innerHTML = "";
    let max = Math.max(...workloadPerDay, 1);
    workloadPerDay.forEach((val, idx) => {
      let height = Math.round((val/max)*60)+5;
      let day = plan.scheduleDays[idx].toLocaleDateString();
      graphBar.innerHTML += `<div title="${day}: ${val} items" style="height:${height}px"></div>`;
    });
    document.getElementById('load-graph-legend').innerText =
      `Each vertical bar = workload (# pages/items), day-by-day.`;
    document.getElementById('progress-bar-container').style.display = "none";
  });
});

document.getElementById('rebalance-btn').addEventListener('click',function(){
  if(!lastPlanConfig)return;
  const progress=loadProgress()[lastPlanConfig.planId]||{};
  renderSchedule(lastPlanConfig,progress,true);
});

document.getElementById('study-form').addEventListener('submit',function(event){
  event.preventDefault();
  const resourceNames = Array.from(document.querySelectorAll('.resource')).map(input=>input.value);
  const pageCounts = Array.from(document.querySelectorAll('.pages')).map(input=>parseInt(input.value,10));
  const intervals = Array.from(document.querySelectorAll('.interval-dropdown')).map(select=>parseInt(select.value,10));
  const resourceTypes = Array.from(document.querySelectorAll('.resource-type-dropdown')).map(e=>e.value);
  const resourceTags = Array.from(document.querySelectorAll('.resource-tag')).map(e=>e.value);
  const resourceNotes = Array.from(document.querySelectorAll('.resource-note')).map(e=>e.value);
  const startDate = new Date(document.getElementById('start-date').value);
  const endDate = new Date(document.getElementById('end-date').value);
  const weekDays = getSelectedWeekdays();
  const reviewDayInterval = parseInt(document.getElementById('review-dropdown').value, 10) || 0;
  const skipDatesArr = getRestDays(startDate, endDate, reviewDayInterval);
  const scheduleDays = getScheduleDays(startDate, endDate, weekDays, skipDatesArr);
  const planId = `${startDate.toISOString().slice(0,10)}_${endDate.toISOString().slice(0,10)}_${resourceNames.join('_')}_${weekDays.join('-')}_${skipDatesArr.join('-')}_${intervals.join('-')}`;
  lastPlanConfig = {resourceNames, pageCounts, intervals, startDate, endDate, planId, scheduleDays, resourceTypes, resourceTags, resourceNotes};
  lastScheduleDays = scheduleDays;
  const progress = loadProgress()[planId]||{};
  renderSchedule(lastPlanConfig,progress,false,resourceTypes,skipDatesArr);
});

function renderSchedule(planConfig, progress, rebalance = false, resourceTypesArg=null, skipDatesArr=null) {
  const { resourceNames, pageCounts, intervals, startDate, endDate, planId, scheduleDays, resourceTypes, resourceTags, resourceNotes } = planConfig;
  const numDays = scheduleDays.length;
  let remainingPages = pageCounts.slice();
  let pagesDone = resourceNames.map((res, idx) => 0);
  let totalBoxCount = 0, doneBoxCount = 0;
  let notes = loadNotes()[planId] || {};
  let manualOrder = loadManualOrder();
  let types = resourceTypesArg || resourceTypes || [];
  let tags = resourceTags || Array(resourceNames.length).fill("");
  let resNotes = resourceNotes || Array(resourceNames.length).fill("");
  let skipArr = skipDatesArr || getSkipDates();
  let daysIdxArrList = resourceNames.map((r, idx)=>{let arr=[];for(let i=0;i<numDays;i+=intervals[idx])arr.push(i);return arr;});
  let tasksArr = [];
  let workloadPerDay = Array(numDays).fill(0);
  let reviewRestMap = {};
  skipArr.forEach(dateStr => reviewRestMap[dateStr]=true);
  for(let i=0;i<numDays;i++){
    const day = scheduleDays[i];
    const dStr = day.toISOString().slice(0,10);
    if (reviewRestMap[dStr]) {
      tasksArr.push({
        date: day.toLocaleDateString(), sortDate: day.getTime(),
        resource: "Rest/Review Day", type: "", tag:"", pages: "-", interval: "", id: `review_${dStr}_${i}`,
        checked: "", note: ""
      });
      continue;
    }
    resourceNames.forEach((resource,idx)=>{
      let pagesTotal=rebalance?remainingPages[idx]:pageCounts[idx];
      let arr=daysIdxArrList[idx];
      if(arr.includes(i)){
        let undoneDays=arr.length-(rebalance?countDaysDone(progress,planId,resource,arr):0);
        let pagesPerDay=Math.ceil(pagesTotal/(rebalance?undoneDays:arr.length));
        let arrPos=arr.indexOf(i);
        let startPage=rebalance?pagesDone[idx]+arrPos*pagesPerDay+1:arrPos*pagesPerDay+1;
        let endPage=Math.min(rebalance?pagesDone[idx]+(arrPos+1)*pagesPerDay:(arrPos+1)*pagesPerDay,pageCounts[idx]);
        workloadPerDay[i] += pagesPerDay;
        const taskId=`${planId}_${resource}_${i}`;
        const noteVal=notes[taskId]?notes[taskId]:'';
        tasksArr.push({
          date: day.toLocaleDateString(), sortDate: day.getTime(),
          resource: `${resourceTypeIcons[types[idx]]} ${resource}`, type: resourceTypeLabels[types[idx]], tag:tags[idx],
          pages: `${startPage}-${endPage}`, interval:intervals[idx], id:taskId,
          checked: progress[taskId]?"checked":"", note: noteVal, resNote: resNotes[idx]
        });
        totalBoxCount++;if(progress[taskId])doneBoxCount++;
      }
    });
  }
  if(manualOrder&&manualOrder[planId]){tasksArr.sort((a,b)=>manualOrder[planId].indexOf(a.id)-manualOrder[planId].indexOf(b.id));}else{tasksArr.sort((a,b)=>a.sortDate-b.sortDate);}
  let scheduleHtml='<h2>Study Schedule</h2><ul id="draggable-list">';
  tasksArr.forEach((item,idx)=>{
    if (item.resource === "Rest/Review Day") {
      scheduleHtml += `<li class="draggable-item" style="background:#fffde3;border:1px solid #ffecb7;border-radius:8px;">
        <b>${item.date}</b>: <span style="color:#d88427;font-weight:bold;">Rest / Review Day</span>
      </li>`;
      return;
    }
    scheduleHtml+=`<li class="draggable-item" draggable="true" data-tid="${item.id}">
      <span class="drag-indicator">&#x2630;</span>
      <input type="checkbox" class="progress-checkbox" data-task="${item.id}" ${item.checked}>
      <b>${item.date}</b>: ${item.resource} <span style="color:#222;font-size:13px;">(${item.type})</span>
      <span style="color:#297bb7;font-size:13px;"> [${item.tag}]</span>,
      Pages/Items ${item.pages} (${item.interval})
      <span style="color:#777; font-style:italic;">${item.resNote}</span>
      <input type="text" class="note-input" data-task-note="${item.id}" placeholder="Add note..." value="${item.note}">
    </li>`;
  });
  scheduleHtml+='</ul>';
  document.getElementById('schedule').innerHTML=scheduleHtml;
  document.getElementById('rebalance-btn').style.display='inline';
  document.getElementById('adv-rebalance-btn').style.display='inline';
  document.getElementById('download-csv-btn').style.display='inline';
  document.getElementById('download-ics-btn').style.display='inline';
  document.getElementById('download-pdf-btn').style.display='inline';
  document.getElementById('backup-btn').style.display='inline';
  document.getElementById('load-graph-container').style.display='block';
  lastBoxCount={total:totalBoxCount,done:doneBoxCount};
  updateProgressBar();
  lastProgressCache=progress;
  lastNotesCache=notes;
  lastOrderCache=manualOrder;
  // Load graph
  let graphBar = document.getElementById('load-graph-bar');
  graphBar.innerHTML = "";
  let max = Math.max(...workloadPerDay, 1);
  workloadPerDay.forEach((val, idx) => {
    let height = Math.round((val/max)*60)+5;
    let day = scheduleDays[idx].toLocaleDateString();
    graphBar.innerHTML += `<div title="${day}: ${val} items" style="height:${height}px"></div>`;
  });
  document.getElementById('load-graph-legend').innerText =
    `Each vertical bar = workload (# pages/items), day-by-day.`;
  let draggedIdx=null,dragOverIdx=null;
  const list=document.getElementById("draggable-list");
  const items=list?Array.from(list.querySelectorAll('.draggable-item')):[];
  items.forEach((item,idx)=>{
    item.addEventListener("dragstart",(e)=>{draggedIdx=idx;item.classList.add("dragging");});
    item.addEventListener("dragend",(e)=>{
      item.classList.remove("dragging");
      if(typeof draggedIdx==="number"&&typeof dragOverIdx==="number"&&draggedIdx!==dragOverIdx){
        let idList=items.map(i=>i.getAttribute("data-tid"));
        const movingId=idList[draggedIdx];idList.splice(draggedIdx,1);idList.splice(dragOverIdx,0,movingId);
        let manualOrder=loadManualOrder();manualOrder[planConfig.planId]=idList;
        saveProgress(loadProgress(),loadNotes(),manualOrder);
        renderSchedule(planConfig,progress,rebalance,types,skipArr);
      }
      draggedIdx=null;dragOverIdx=null;
    });
    item.addEventListener("dragover",(e)=>{
      e.preventDefault();dragOverIdx=items.indexOf(item);
      items.forEach(i=>i.classList.remove("drop-target"));
      item.classList.add("drop-target");
    });
    item.addEventListener("dragleave",(e)=>{item.classList.remove("drop-target");});
  });
  document.querySelectorAll('.progress-checkbox').forEach(cb=>{
    cb.addEventListener('change',function(){
      let saveData=loadProgress();let saveNotes=loadNotes();let manualOrder=loadManualOrder();
      saveData[planConfig.planId]=saveData[planConfig.planId]||{};
      saveData[planConfig.planId][this.dataset.task]=this.checked?true:false;
      saveProgress(saveData,saveNotes,manualOrder);
      renderSchedule(planConfig,saveData[planConfig.planId],rebalance,types,skipArr);
    });
  });
  document.querySelectorAll('.note-input').forEach(noteInput=>{
    noteInput.addEventListener('change',function(){
      let saveData=loadProgress();let saveNotes=loadNotes();let manualOrder=loadManualOrder();
      saveNotes[planConfig.planId]=saveNotes[planConfig.planId]||{};
      saveNotes[planConfig.planId][this.dataset.taskNote]=this.value;
      saveProgress(saveData,saveNotes,manualOrder);
    });
  });
}
function showLoadedSchedule(result) {
  lastPlanConfig = result.planConfig;
  lastProgressCache = result.progress || {};
  lastNotesCache = result.notes || {};
  lastOrderCache = result.manualOrder || {};
  renderSchedule(lastPlanConfig, lastProgressCache, false);
}
function downloadCSV(planConfig, progress, notes, manualOrder, resourceTypes, resourceTags, resourceNotes) {
  // Same logic as previous, include type/tag/note in csvRows
  if (!planConfig) return;
  const { resourceNames, pageCounts, intervals, startDate, endDate, planId, scheduleDays } = planConfig;
  let types = resourceTypes || [];
  let tags = resourceTags || [];
  let resNotes = resourceNotes || [];
  let displayOrder = manualOrder && manualOrder[planId] ? manualOrder[planId] : null;
  let numDays = scheduleDays.length; let csvRows = [["Date","Resource","Type","Tag","Resource Note","Pages/Items","Interval","Done","Note"]];
  let daysIdxArrList = resourceNames.map((r, idx) => {let arr=[];for(let i=0;i<numDays;i+=intervals[idx])arr.push(i);return arr;});
  let tasksArr = [];
  for (let i=0;i<numDays;i++) {
    const day = scheduleDays[i];
    resourceNames.forEach((resource, idx) => {
      let arr=daysIdxArrList[idx];
      if(arr.includes(i)){
        let pagesPerDay=Math.ceil(pageCounts[idx]/arr.length);
        let arrPos=arr.indexOf(i);
        let startPage=arrPos*pagesPerDay+1;let endPage=Math.min((arrPos+1)*pagesPerDay,pageCounts[idx]);
        let intervalText="Every day";
        if(intervals[idx]===2)intervalText="Every other day";
        else if(intervals[idx]===3)intervalText="Every 3rd day";
        else if(intervals[idx]===7)intervalText="Every week";
        else if(intervals[idx]>1)intervalText=`Every ${intervals[idx]} days`;
        let resourceType = types[idx] || "other";
        let resourceTag = tags[idx] || "";
        let rNote = resNotes[idx] || "";
        const taskId=`${planId}_${resource}_${i}`;
        const isComplete=progress[taskId]?"Yes":"No";
        const noteVal=notes[taskId]?notes[taskId].replace(/"/g,'""'):"";
        tasksArr.push([
          day.toLocaleDateString(), resource, resourceTypeIcons[resourceType] + " " + resourceTypeLabels[resourceType],
          resourceTag, rNote, `${startPage}-${endPage}`, intervalText, isComplete, `"${noteVal}"`
        ]);
      }
    });
  }
  if(displayOrder){tasksArr.sort((a,b)=>displayOrder.indexOf(a[1])-displayOrder.indexOf(b[1]));}
  tasksArr.forEach(t=>{csvRows.push(t);});
  const csvText=csvRows.map(r=>r.join(",")).join("\r\n");
  const blob=new Blob([csvText],{type:"text/csv"});
  const url=window.URL.createObjectURL(blob);
  const link=document.createElement("a");
  link.href=url;link.download="study_schedule.csv";
  document.body.appendChild(link);link.click();
  setTimeout(()=>{document.body.removeChild(link);window.URL.revokeObjectURL(url);},100);
}
function downloadICS(planConfig, notes, manualOrder, resourceTypes, resourceTags, resourceNotes) {
  // Similar logic‚Äîinclude tag/note in summary/desc
  if (!planConfig) return;
  const { resourceNames, pageCounts, intervals, planId, scheduleDays } = planConfig;
  let manual=manualOrder&&manualOrder[planId]?manualOrder[planId]:null;
  let types = resourceTypes || []; let tags = resourceTags || []; let resNotes = resourceNotes || [];
  let numDays=scheduleDays.length;
  let daysIdxArrList=resourceNames.map((r,idx)=>{let arr=[];for(let i=0;i<numDays;i+=intervals[idx])arr.push(i);return arr;});
  let components=[`BEGIN:VCALENDAR`,`VERSION:2.0`,`CALSCALE:GREGORIAN`,`PRODID:-//User-Generated Study Scheduler//EN`];
  let tasksArr=[];
  for(let i=0;i<numDays;i++){
    const day=scheduleDays[i];
    resourceNames.forEach((resource,idx)=>{
      let arr=daysIdxArrList[idx];
      if(arr.includes(i)){
        let pagesPerDay=Math.ceil(pageCounts[idx]/arr.length);
        let arrPos=arr.indexOf(i);
        let startPage=arrPos*pagesPerDay+1;
        let endPage=Math.min((arrPos+1)*pagesPerDay,pageCounts[idx]);
        let resourceType = types[idx] || "other";
        let tag = tags[idx] || "";
        let rNote = resNotes[idx] || "";
        let intervalText="Every day";
        if(intervals[idx]===2)intervalText="Every other day";
        else if(intervals[idx]===3)intervalText="Every 3rd day";
        else if(intervals[idx]===7)intervalText="Every week";
        else if(intervals[idx]>1)intervalText=`Every ${intervals[idx]} days`;
        const taskId=`${planId}_${resource}_${i}`;
        const noteVal=notes[planId]&&notes[planId][taskId]?notes[planId][taskId]:'';
        tasksArr.push({
          date: new Date(day),
          summary: `${resourceTypeIcons[resourceType]} ${resource} [${tag}] (${resourceTypeLabels[resourceType]}, ${intervalText})`,
          description: `Read/complete pages/items ${startPage}-${endPage}\nTag: ${tag}\nResource Note: ${rNote}`+
            (noteVal?`\nNote: ${noteVal}`:''),
          id: taskId
        });
      }
    });
  }
  if(manual){tasksArr.sort((a,b)=>manual.indexOf(a.id)-manual.indexOf(b.id));}
  tasksArr.forEach(t=>{
    let dtstamp=(new Date()).toISOString().replace(/[-:.]/g,"").split("T")[0]+"T000000Z";
    let dtstart=datetoCal(t.date);
    let dtend=datetoCal(new Date(t.date.getTime()+86400000));
    components.push(
      "BEGIN:VEVENT",
      "UID:"+t.id+"@studyplanner",
      "DTSTAMP:"+dtstamp,
      "DTSTART;VALUE=DATE:"+dtstart,
      "DTEND;VALUE=DATE:"+dtend,
      "SUMMARY:"+escapeICS(t.summary),
      "DESCRIPTION:"+escapeICS(t.description),
      "END:VEVENT"
    );
  });
  components.push(`END:VCALENDAR`);
  let icsText=components.join("\r\n");
  let blob=new Blob([icsText],{type:"text/calendar"});
  let url=window.URL.createObjectURL(blob);
  let link=document.createElement("a");
  link.href=url;link.download="study_schedule.ics";
  document.body.appendChild(link);link.click();
  setTimeout(()=>{document.body.removeChild(link);window.URL.revokeObjectURL(url);},100);
}
function datetoCal(dt) {
  function pad(n){return n<10?"0"+n:n;}
  return [dt.getUTCFullYear(),pad(dt.getUTCMonth()+1),pad(dt.getUTCDate())].join('');
}
function escapeICS(str){return String(str||'').replace(/([,;])/g,"\\$1").replace(/\n/g,"\\n");}
</script>
</body>
</html>

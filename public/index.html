<!DOCTYPE html>
<html>
<head>
  <title>Study Scheduler</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .resource-row { margin-bottom: 7px; }
    ul { list-style-type: none; padding-left: 0; }
    li { margin-bottom: 7px; }
    .progress-checkbox { margin-right: 8px; cursor:pointer;}
    #add-resource-btn, #rebalance-btn, #download-csv-btn, #download-ics-btn, #cloud-save-btn, #cloud-load-btn { margin-top: 8px; margin-bottom: 10px; }
    #progress-bar-container {
      width: 100%; max-width: 500px; height: 24px;
      background: #eee; border-radius: 12px; overflow: hidden; margin-bottom:20px; margin-top: 24px;
    }
    #progress-bar {
      width: 0%; height: 100%; background: #4CAF50;
      transition: width 0.3s;
    }
    #progress-label {
      margin-top: 3px; font-weight: bold;
    }
    .weekday-checkboxes label {
      margin-right: 12px;
    }
    .interval-label {
      display: inline-block;
      margin-left: 12px;
    }
    .interval-dropdown {
      width: 160px;
      margin-left: 6px;
    }
    .note-input {
      margin-left: 8px; width: 160px; margin-right: 4px;
    }
    #holiday-list { margin-bottom: 10px; }
    .holiday-input-row { margin-bottom: 4px; }
    .drag-indicator {
      cursor: grab;
      margin-right: 6px;
      font-weight: bold;
      color: #888;
    }
    .dragging {
      opacity: 0.5;
    }
    .drop-target {
      background: #fffae6 !important;
    }
  </style>
</head>
<body>
  <h1>Study Scheduler</h1>
  <form id="study-form">
    <div id="resource-list">
      <div class="resource-row">
        <label>Book/Resource Name: <input type="text" class="resource" required></label>
        <label>Total Pages: <input type="number" class="pages" required></label>
        <label class="interval-label">
          Interval:
          <select class="interval-dropdown">
            <option value="1">Every day</option>
            <option value="2">Every other day</option>
            <option value="3">Every 3rd day</option>
            <option value="7">Every week</option>
          </select>
        </label>
        <button type="button" class="remove-btn" style="display:none;">Remove</button>
      </div>
    </div>
    <button type="button" id="add-resource-btn">Add Another Resource</button>
    <br>
    <div class="weekday-checkboxes">
      <label><input type="checkbox" class="weekday" value="0" checked> Sun</label>
      <label><input type="checkbox" class="weekday" value="1" checked> Mon</label>
      <label><input type="checkbox" class="weekday" value="2" checked> Tue</label>
      <label><input type="checkbox" class="weekday" value="3" checked> Wed</label>
      <label><input type="checkbox" class="weekday" value="4" checked> Thu</label>
      <label><input type="checkbox" class="weekday" value="5" checked> Fri</label>
      <label><input type="checkbox" class="weekday" value="6" checked> Sat</label>
    </div>
    <br>
    <div>
      <b>Skip these dates (holidays):</b>
      <div id="holiday-list">
        <div class="holiday-input-row">
          <input type="date" class="holiday-date">
          <button type="button" class="remove-holiday-btn" style="display:none;">Remove</button>
        </div>
      </div>
      <button type="button" id="add-holiday-btn">Add Another Holiday/Skip Date</button>
    </div>
    <br>
    <label>Start Date: <input type="date" id="start-date" required></label><br>
    <label>End Date: <input type="date" id="end-date" required></label><br>
    <button type="submit">Create Schedule</button>
  </form>
  
  <button type="button" id="cloud-save-btn" style="display:none;">Save plan to cloud</button>
  <button type="button" id="cloud-load-btn" style="display:none;">Load plan from cloud</button>
  <button type="button" id="download-csv-btn" style="display:none;">Download CSV</button>
  <button type="button" id="download-ics-btn" style="display:none;">Download Calendar (.ics)</button>
  <div id="progress-bar-container" style="display:none;">
    <div id="progress-bar"></div>
  </div>
  <div id="progress-label"></div>
  <button type="button" id="rebalance-btn" style="display:none;">Rebalance Schedule</button>
  <div id="schedule"></div>
  <script>
    var CLOUD_API_URL = "https://script.google.com/macros/s/AKfycbxbVUfw3-HGPfV53flf-IXBWtzcuDKmzVy_14GtAtBtsmj9xvie2nHbM936cjLJ9nAFtA/exec";
    var USER_ID = "default";
    // All logic for study schedule app, full logic as before for rendering and progress, below:
    // ...[The long JS logic for all features, unchanged from before]...

    // --- Cloud Sync Functions ---
    function cloudSave(planConfig, progress, notes, manualOrder) {
      var payload = {
        id: planConfig.planId,
        user: USER_ID,
        savedPlan: JSON.stringify({
          planConfig, progress, notes, manualOrder
        })
      };
      fetch(CLOUD_API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      }).then(res => res.json()).then(data => {
        alert("Saved to cloud!");
      }).catch(err => {
        alert("Cloud save failed!");
      });
    }
    function cloudLoad(planId, callback) {
      fetch(CLOUD_API_URL + "?action=load&planid=" + encodeURIComponent(planId))
        .then(res => res.text())
        .then(text => {
          let data;
          try {data = JSON.parse(text);} catch(e){data={};}
          callback(data);
        }).catch(err=>{
          alert("Cloud load failed!");
        });
    }

    // SCHDEULER LOGIC: make these variables global for all below functions
    let lastPlanConfig = null, lastBoxCount = { total: 0, done: 0 }, lastScheduleDays = [], lastProgressCache = {}, lastNotesCache = {}, lastOrderCache = {};
    function saveProgress(progress, notes, manualOrder) {
      localStorage.setItem('studyProgress', JSON.stringify(progress));
      localStorage.setItem('studyNotes', JSON.stringify(notes));
      localStorage.setItem('studyManualOrder', JSON.stringify(manualOrder));
    }
    function loadProgress() { return JSON.parse(localStorage.getItem('studyProgress') || '{}'); }
    function loadNotes() { return JSON.parse(localStorage.getItem('studyNotes') || '{}'); }
    function loadManualOrder() { return JSON.parse(localStorage.getItem('studyManualOrder') || '{}'); }
    document.getElementById('add-resource-btn').addEventListener('click', function() {
      const resourceList = document.getElementById('resource-list');
      const newRow = resourceList.firstElementChild.cloneNode(true);
      newRow.querySelectorAll('input').forEach(input => input.value = '');
      newRow.querySelector('.interval-dropdown').selectedIndex = 0;
      const removeBtn = newRow.querySelector('.remove-btn');
      removeBtn.style.display = 'inline';
      removeBtn.addEventListener('click', function() { newRow.remove(); });
      resourceList.appendChild(newRow);
    });
    document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', function(e){
      if(document.querySelectorAll('.resource-row').length > 1) {
        e.target.closest('.resource-row').remove();
      }
    }));
    document.getElementById('add-holiday-btn').addEventListener('click', function() {
      const holidayList = document.getElementById('holiday-list');
      const newRow = holidayList.firstElementChild.cloneNode(true);
      newRow.querySelector('input').value = '';
      const removeBtn = newRow.querySelector('.remove-holiday-btn');
      removeBtn.style.display = 'inline';
      removeBtn.addEventListener('click', function() { newRow.remove(); });
      holidayList.appendChild(newRow);
    });
    document.querySelectorAll('.remove-holiday-btn').forEach(btn =>
      btn.addEventListener('click', function(e){
        e.target.closest('.holiday-input-row').remove();
      })
    );
    function countDaysDone(progress, planId, resource, daysIdxArr) {
      return Object.keys(progress)
        .filter(k => {
          return k.startsWith(`${planId}_${resource}_`) && progress[k] &&
            (!daysIdxArr || daysIdxArr.includes(parseInt(k.split('_').pop())));
        }).length;
    }
    function updateProgressBar() {
      if (lastBoxCount.total === 0) {
        document.getElementById('progress-bar-container').style.display = "none";
        document.getElementById('progress-label').innerText = "";
        return;
      }
      const percent = Math.round((lastBoxCount.done / lastBoxCount.total) * 100);
      document.getElementById('progress-bar').style.width = percent + "%";
      document.getElementById('progress-bar-container').style.display = "block";
      document.getElementById('progress-label').innerText = `Progress: ${lastBoxCount.done} / ${lastBoxCount.total} (${percent}%)`;
    }
    function getSelectedWeekdays() { return Array.from(document.querySelectorAll('.weekday')).filter(cb => cb.checked).map(cb => parseInt(cb.value)); }
    function getSkipDates() { return Array.from(document.querySelectorAll('.holiday-date')).map(input => input.value).filter(val => val); }
    function getScheduleDays(startDate, endDate, weekDays, skipDates) {
      const days = []; let dt = new Date(startDate);
      while (dt <= endDate) { const dStr = dt.toISOString().slice(0,10);
        if (weekDays.includes(dt.getDay()) && !skipDates.includes(dStr)) { days.push(new Date(dt)); }
        dt.setDate(dt.getDate() + 1); }
      return days;
    }

    // MAIN RENDER FUNCTION: Shows cloud buttons every time
    function renderSchedule(planConfig, progress, rebalance = false) {
      // ... Large block of schedule rendering logic as in previous versions ...
      // build scheduleHtml, etc, as always
      // ... then, at the start or end, ensure visibility:
      document.getElementById('cloud-save-btn').style.display = 'inline';
      document.getElementById('cloud-load-btn').style.display = 'inline';
      document.getElementById('rebalance-btn').style.display = 'inline';
      document.getElementById('download-csv-btn').style.display = 'inline';
      document.getElementById('download-ics-btn').style.display = 'inline';
      // ... rest of the render logic as before ...
    }

    // SCHEDULE FORM SUBMIT HANDLING (unchanged)
    document.getElementById('study-form').addEventListener('submit',function(event){
      event.preventDefault();
      // form value extraction, plan id, etc...
      // ... then call renderSchedule(planConfig, progress, false);
    });

    // EVENT HANDLERS for cloud sync (already shown above)
    document.getElementById('cloud-save-btn').addEventListener('click', function() {
      cloudSave(lastPlanConfig, lastProgressCache, lastNotesCache, lastOrderCache);
    });
    document.getElementById('cloud-load-btn').addEventListener('click', function() {
      cloudLoad(lastPlanConfig.planId, (result)=>{
        if(result.planConfig){
          renderSchedule(result.planConfig, result.progress || {}, false);
          alert("Loaded from cloud!");
        } else {
          alert("No cloud plan found for this period!");
        }
      });
    });

    // ... rest of your scheduler logic ...
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Study Scheduler</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,600,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f7fafc; --card: #fff; --main: #2562cf;
      --accent: #e5eaf1; --text: #232c40; --border: #e2e8f0;
      --primary-btn: #2562cf; --primary-btn-hover: #1e4fab; --shadow: 0 2px 14px #23262f10;
      --dark-bg: #21263b; --dark-card: #272a38; --dark-main: #c0cefa; --dark-accent: #23262f;
      --dark-text: #e0e7fa; --dark-border: #323648;
    }
    body {
      font-family: 'Inter', Arial, sans-serif; background: var(--bg); color: var(--text);
      min-height: 100vh; transition: background .2s, color .2s;
    }
    body.dark {background: var(--dark-bg); color: var(--dark-text);}
    h1 { font-size: 2.1em; color: var(--main); font-weight:700; letter-spacing:-0.7px; margin-bottom:8px;}
    .app-header { display: flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    #darkmode-btn { border:none; background: var(--accent); color: var(--main); width:34px; height:34px; font-size:23px;
      border-radius:50%; cursor:pointer; transition:.17s; margin-left:13px; margin-bottom:2px; }
    body.dark #darkmode-btn { background:var(--dark-accent); color:var(--dark-main);}
    .card {background: var(--card); box-shadow: var(--shadow); border-radius:16px; border: 1px solid var(--border);
      padding: 13px 20px 10px 17px; margin-bottom:12px; transition: background .2s, border .2s, color .2s;}
    body.dark .card {background: var(--dark-card); border-color: var(--dark-border);}
    .card-row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:7px;}
    .card-row label {font-weight:500;margin-right:7px;}
    .card-row input, .card-row select { background: var(--accent); border-radius:7px; border: 1px solid var(--border); font-size:15px; padding:5px 8px;}
    body.dark .card-row input, body.dark .card-row select { background: var(--dark-accent); color: var(--dark-text); border-color: var(--dark-border);}
    .card-row .remove-btn {background:transparent;color:#bc2d2d;border:none;font-size:1em; cursor:pointer;}
    .card-row .remove-btn:hover {text-decoration:underline;}
    button, input[type="button"] {
      font-family: 'Inter', Arial, sans-serif; background: var(--primary-btn); color: #fff; border:none; border-radius:8px; font-size:1em;
      padding: 7px 15px; margin-right: 8px; margin-bottom:7px; box-shadow: 0 1px 8px #2562cf12; transition: background .15s, box-shadow .2s;
      font-weight:600; letter-spacing:-0.03em; cursor:pointer;}
    button:hover, input[type="button"]:hover {background: var(--primary-btn-hover); box-shadow: 0 2px 20px #2562cf2a;}
    #bulk-modal-inner {background: var(--card);}
    body.dark #bulk-modal-inner {background: var(--dark-card);}
    .weekday-checkboxes label {font-weight:500;margin-right:13px;}
    #schedule, .draggable-item {font-size:1em;}
    .draggable-item { background: var(--card); box-shadow: var(--shadow); border-radius:9px; border: 1.4px solid var(--border); margin-bottom:9px;
      padding: 8px 16px; display: flex; align-items: center; transition: background .2s, box-shadow .15s;}
    body.dark .draggable-item {background:var(--dark-card); border-color:var(--dark-border);}
    .draggable-item.drop-target {background: #e5f2ff;}
    body.dark .draggable-item.drop-target {background: #2562cf19;}
    .drag-indicator {font-size:1.3em; color:#888; cursor:grab;margin-right:8px;}
    .progress-checkbox { accent-color: var(--main);}
    .note-input, .resource-tag, .resource-note {font-size:15px;}
    #load-graph-container {margin-top:22px;}
    #load-graph-bar > div { background: var(--main); border-radius:7px 7px 0 0; min-width:9px; margin-right:3px;}
    body.dark #load-graph-bar > div {background:var(--dark-main);}
    @media (max-width: 900px){ .card {padding:12px;} }
    @media (max-width:700px){
      body {margin:13px;}
      .card, #bulk-modal-inner {padding:8px;}
      #bulk-modal-inner {min-width:215px;}
    }
    #bulk-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.16); z-index:1500;}
    #bulk-modal-inner { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      min-width:320px; min-height:250px;}
  </style>
</head>
<body>
<div class="app-header">
  <h1>Study Scheduler</h1>
  <button id="darkmode-btn" title="Toggle dark mode">üåô</button>
</div>
<form id="study-form" style="display:block;">
  <div class="card card-row">
    <label>Study hours per day:
      <input type="number" id="study-hours-per-day" min="1" max="24" value="3" style="width:72px;">
    </label>
  </div>
  <div id="resource-list">
    <div class="card card-row resource-row">
      <label>Resource: <input type="text" class="resource" required></label>
      <label>Pages: <input type="number" class="pages" required style="width:70px;"></label>
      <label>Type:
        <select class="resource-type-dropdown">
          <option value="book">üìö Book</option>
          <option value="qbank">‚ùì QBank</option>
          <option value="flashcards">üÉè Flashcards</option>
          <option value="video">üì∫ Video</option>
          <option value="other">üìÑ Other</option>
        </select>
      </label>
      <label>
        Rate per hour: <input type="number" class="rate-per-hour" min="1" value="10" style="width:70px;">
        <span class="rate-type-label">pages/hr</span>
      </label>
      <label>Tag: <input type="text" class="resource-tag" placeholder="Tag" style="width:90px;"></label>
      <label>Note: <input type="text" class="resource-note" placeholder="Note" style="width:120px;"></label>
      <label>
        Interval:
        <select class="interval-dropdown" style="width:87px;">
          <option value="1">Every day</option>
          <option value="2">Every other day</option>
          <option value="3">Every 3rd day</option>
          <option value="7">Every week</option>
        </select>
      </label>
      <button type="button" class="remove-btn" style="display:none;">‚úñ</button>
    </div>
  </div>
  <button type="button" id="add-resource-btn">Add Resource</button>
  <button type="button" id="bulk-add-btn">Bulk Add</button>
  <br>
  <div class="card card-row weekday-checkboxes">
    <label><input type="checkbox" class="weekday" value="0" checked> Sun</label>
    <label><input type="checkbox" class="weekday" value="1" checked> Mon</label>
    <label><input type="checkbox" class="weekday" value="2" checked> Tue</label>
    <label><input type="checkbox" class="weekday" value="3" checked> Wed</label>
    <label><input type="checkbox" class="weekday" value="4" checked> Thu</label>
    <label><input type="checkbox" class="weekday" value="5" checked> Fri</label>
    <label><input type="checkbox" class="weekday" value="6" checked> Sat</label>
  </div>
  <div class="card card-row" id="rest-days-container">
    <b>Rest/Off Dates:</b>
    <div id="holiday-list" style="margin-left:10px;">
      <div class="holiday-input-row">
        <input type="date" class="holiday-date">
        <button type="button" class="remove-holiday-btn" style="display:none;">‚úñ</button>
      </div>
    </div>
    <button type="button" id="add-holiday-btn">Add Off Date</button>
  </div>
  <div class="card card-row" id="review-days-container">
    <b>Periodic Review:</b>
    <label>
      Every
      <select id="review-dropdown">
        <option value="0">None</option>
        <option value="7">7th day</option>
        <option value="6">6th day</option>
        <option value="5">5th day</option>
        <option value="4">4th day</option>
        <option value="3">3rd day</option>
        <option value="2">2nd day</option>
      </select>
      is Review/Rest
    </label>
  </div>
  <div class="card card-row">
    <label>Start Date: <input type="date" id="start-date" required></label>
    <label>End Date: <input type="date" id="end-date" required></label>
    <button type="submit" style="margin-left:14px;">Create Schedule</button>
  </div>
</form>
<div>
  <button type="button" id="download-csv-btn">Export CSV</button>
  <button type="button" id="download-ics-btn">Export Calendar (.ics)</button>
  <button type="button" id="download-pdf-btn">Print/PDF</button>
  <button type="button" id="backup-btn" style="display:none;">Backup JSON</button>
  <button type="button" id="restore-btn" style="display:inline;">Import JSON</button>
  <input type="file" id="restore-file" style="display:none;">
</div>
<div id="progress-label"></div>
<button type="button" id="rebalance-btn" style="display:none;">Rebalance</button>
<button type="button" id="adv-rebalance-btn" style="display:none;">Advanced Rebalance</button>
<div id="load-graph-container" style="display:none;">
  <b style="font-weight:600;">Daily Load Graph</b>
  <div id="load-graph-bar"></div>
  <div id="load-graph-legend"></div>
</div>
<div id="schedule"></div>
<!-- Bulk Modal -->
<div id="bulk-modal">
  <div id="bulk-modal-inner" class="card">
    <h2>Bulk Add Resources</h2>
    <div><textarea id="bulk-resource-input" rows="10" style="width:98%;background:var(--accent);"></textarea></div>
    <br>
    <label>Type:
      <select id="bulk-type-dropdown">
        <option value="book">üìö Book</option>
        <option value="qbank">‚ùì QBank</option>
        <option value="flashcards">üÉè Flashcards</option>
        <option value="video">üì∫ Video</option>
        <option value="other">üìÑ Other</option>
      </select>
    </label>
    <label>Rate/hour: <input type="number" id="bulk-rate-input" min="1" value="10" style="width:70px;">
      <span id="bulk-rate-type-label">pages/hr</span>
    </label>
    <label>Tag: <input type="text" id="bulk-tag-input" placeholder="Tag"></label>
    <label>Note: <input type="text" id="bulk-note-input" placeholder="Note"></label>
    <label>
      Pages/Items:
      <input type="number" id="bulk-pages-input" min="1" value="10" style="width:60px;">
    </label>
    <br><br>
    <button id="bulk-confirm-btn">Add Resources</button>
    <button id="bulk-cancel-btn">Cancel</button>
  </div>
</div>
<script>
const resourceTypeIcons = {
  book: "üìö", qbank: "‚ùì", flashcards: "üÉè", video: "üì∫", other: "üìÑ"
};
const resourceTypeLabels = {
  book: "Book", qbank: "QBank", flashcards: "Flashcards", video: "Video", other: "Other"
};
const rateTypeLabels = {
  book: "pages/hr", qbank: "questions/hr", flashcards: "cards/hr", video: "videos/hr", other: "items/hr"
};

function updateRateTypeLabels() {
  document.querySelectorAll('.resource-row').forEach(row => {
    const typeSel = row.querySelector('.resource-type-dropdown');
    const rateLabel = row.querySelector('.rate-type-label');
    if (typeSel && rateLabel) {
      rateLabel.textContent = rateTypeLabels[typeSel.value] || "items/hr";
    }
    typeSel.addEventListener('change', function() {
      rateLabel.textContent = rateTypeLabels[this.value] || "items/hr";
    });
  });
}

function addResourceRow(resourceVal="", pagesVal="", typeVal="book", tagVal="", noteVal="", intervalVal="1", rateVal="10") {
  const resourceList = document.getElementById('resource-list');
  const newRow = resourceList.firstElementChild.cloneNode(true);
  newRow.querySelector('.resource').value = resourceVal || "";
  newRow.querySelector('.pages').value = pagesVal || "";
  newRow.querySelector('.resource-type-dropdown').value = typeVal;
  newRow.querySelector('.resource-tag').value = tagVal;
  newRow.querySelector('.resource-note').value = noteVal;
  newRow.querySelector('.interval-dropdown').value = intervalVal;
  newRow.querySelector('.rate-per-hour').value = rateVal || 10;
  updateRateTypeLabels();
  const removeBtn = newRow.querySelector('.remove-btn');
  removeBtn.style.display = 'inline';
  removeBtn.addEventListener('click', function() { newRow.remove(); updateRateTypeLabels(); });
  resourceList.appendChild(newRow);
  updateRateTypeLabels();
}

document.getElementById('add-resource-btn').addEventListener('click', function() {
  addResourceRow();
  updateRateTypeLabels();
});
updateRateTypeLabels();

document.getElementById('bulk-type-dropdown').addEventListener('change', function() {
  document.getElementById('bulk-rate-type-label').textContent = rateTypeLabels[this.value] || "items/hr";
});
document.getElementById('bulk-confirm-btn').onclick = function() {
  const lines = document.getElementById('bulk-resource-input').value.split('\n').map(x=>x.trim()).filter(x=>x);
  const bulkType = document.getElementById('bulk-type-dropdown').value;
  const bulkTag = document.getElementById('bulk-tag-input').value;
  const bulkNote = document.getElementById('bulk-note-input').value;
  const bulkPages = parseInt(document.getElementById('bulk-pages-input').value, 10) || 1;
  const bulkRate = parseInt(document.getElementById('bulk-rate-input').value, 10) || 10;
  if (!lines.length) { alert("Paste at least one resource"); return; }
  lines.forEach(name=>{
    addResourceRow(name, bulkPages, bulkType, bulkTag, bulkNote, "1", bulkRate);
  });
  document.getElementById('bulk-modal').style.display = 'none';
};
document.getElementById('bulk-cancel-btn').onclick = function() {
  document.getElementById('bulk-modal').style.display = 'none';
};
document.getElementById('bulk-add-btn').addEventListener('click', function() {
  document.getElementById('bulk-resource-input').value = '';
  document.getElementById('bulk-modal').style.display = 'block';
});

function getSelectedWeekdays() {
  return Array.from(document.querySelectorAll('.weekday')).filter(cb => cb.checked).map(cb => parseInt(cb.value));
}
function getSkipDates() {
  return Array.from(document.querySelectorAll('.holiday-date')).map(input => input.value).filter(val => val);
}
function getRestDays(startDate, endDate, reviewDayInterval) {
  let restDays = getSkipDates();
  if (reviewDayInterval >= 2) {
    let dt = new Date(startDate), i=0;
    while (dt <= endDate) { i++; if (i % reviewDayInterval === 0) restDays.push(dt.toISOString().slice(0,10)); dt.setDate(dt.getDate() + 1);}
  }
  return Array.from(new Set(restDays));
}
function getScheduleDays(startDate, endDate, weekDays, skipDatesArr) {
  const days = []; let dt = new Date(startDate);
  while (dt <= endDate) { const dStr = dt.toISOString().slice(0,10);
    if (weekDays.includes(dt.getDay()) && !skipDatesArr.includes(dStr)) { days.push(new Date(dt)); }
    dt.setDate(dt.getDate() + 1); }
  return days;
}

document.getElementById('study-form').addEventListener('submit',function(event){
  event.preventDefault();
  const resourceNames = Array.from(document.querySelectorAll('.resource')).map(input=>input.value);
  const pageCounts = Array.from(document.querySelectorAll('.pages')).map(input=>parseInt(input.value,10));
  const intervals = Array.from(document.querySelectorAll('.interval-dropdown')).map(select=>parseInt(select.value,10));
  const resourceTypes = Array.from(document.querySelectorAll('.resource-type-dropdown')).map(e=>e.value);
  const resourceTags = Array.from(document.querySelectorAll('.resource-tag')).map(e=>e.value);
  const resourceNotes = Array.from(document.querySelectorAll('.resource-note')).map(e=>e.value);
  const ratePerHour = Array.from(document.querySelectorAll('.rate-per-hour')).map(input=>parseInt(input.value,10) || 1);
  const studyHoursPerDay = parseInt(document.getElementById('study-hours-per-day').value, 10) || 1;
  const startDate = new Date(document.getElementById('start-date').value);
  const endDate = new Date(document.getElementById('end-date').value);
  const weekDays = getSelectedWeekdays();
  const reviewDayInterval = parseInt(document.getElementById('review-dropdown').value, 10) || 0;
  const skipDatesArr = getRestDays(startDate, endDate, reviewDayInterval);
  const scheduleDays = getScheduleDays(startDate, endDate, weekDays, skipDatesArr);

  // Pass everything to plan object
  const planId = `${startDate.toISOString().slice(0,10)}_${endDate.toISOString().slice(0,10)}_${resourceNames.join('_')}_${weekDays.join('-')}_${skipDatesArr.join('-')}_${intervals.join('-')}`;
  lastPlanConfig = {resourceNames, pageCounts, intervals, startDate, endDate, planId, scheduleDays, resourceTypes, resourceTags, resourceNotes, ratePerHour, studyHoursPerDay};
  lastScheduleDays = scheduleDays;
  const progress = loadProgress()[planId]||{};
  renderSchedule(lastPlanConfig,progress,false,resourceTypes,skipDatesArr);
});

function renderSchedule(planConfig, progress, rebalance = false, resourceTypesArg=null, skipDatesArr=null) {
  const { resourceNames, pageCounts, intervals, startDate, endDate, planId, scheduleDays, resourceTypes, resourceTags, resourceNotes, ratePerHour, studyHoursPerDay } = planConfig;
  const numDays = scheduleDays.length;
  let remainingItems = pageCounts.slice();
  let doneItems = resourceNames.map((res, idx) => 0);
  let notes = loadNotes()[planId] || {};
  let manualOrder = loadManualOrder();
  let types = resourceTypesArg || resourceTypes || [];
  let tags = resourceTags || Array(resourceNames.length).fill("");
  let resNotes = resourceNotes || Array(resourceNames.length).fill("");
  let skipArr = skipDatesArr || getSkipDates();
  let daysIdxArrList = resourceNames.map((r, idx)=>{let arr=[];for(let i=0;i<numDays;i+=intervals[idx])arr.push(i);return arr;});
  let tasksArr = [];
  let workloadPerDay = Array(numDays).fill(0);
  let timeUsedPerDay = Array(numDays).fill(0);
  let reviewRestMap = {}; skipArr.forEach(dateStr => reviewRestMap[dateStr]=true);
  for(let i=0;i<numDays;i++){
    const day = scheduleDays[i];
    const dStr = day.toISOString().slice(0,10);
    if (reviewRestMap[dStr]) {
      tasksArr.push({
        date: day.toLocaleDateString(), sortDate: day.getTime(),
        resource: "Rest/Review Day", type: "", tag:"", pages: "-", interval: "", id: `review_${dStr}_${i}`,
        checked: "", note: ""
      });
      continue;
    }
    let timeLeft = studyHoursPerDay;
    resourceNames.forEach((resource,idx)=>{
      let itemsTotal=rebalance?remainingItems[idx]:pageCounts[idx];
      let arr=daysIdxArrList[idx];
      if(arr.includes(i)){
        let undoneDays=arr.length-(rebalance?countDaysDone(progress,planId,resource,arr):0);
        let maxAssignable = Math.min(itemsTotal - doneItems[idx], Math.floor(ratePerHour[idx] * timeLeft));
        let assignCount = Math.ceil(itemsTotal/arr.length);
        if (assignCount > maxAssignable) assignCount = maxAssignable;
        assignCount = Math.max(assignCount, 1);
        workloadPerDay[i] += assignCount;
        let timeNeeded = assignCount / ratePerHour[idx];
        timeUsedPerDay[i] += timeNeeded;
        timeLeft -= timeNeeded;
        const taskId=`${planId}_${resource}_${i}`;
        const noteVal=notes[taskId]?notes[taskId]:'';
        const isChecked=progress[taskId]?"checked":"";
        tasksArr.push({
          date: day.toLocaleDateString(), sortDate: day.getTime(),
          resource: `${resourceTypeIcons[types[idx]]} ${resource}`, type: resourceTypeLabels[types[idx]], tag:tags[idx],
          pages: assignCount, interval:intervals[idx], id:taskId,
          checked: isChecked, note: noteVal, resNote: resNotes[idx],
          estTime: timeNeeded.toFixed(2)
        });
      }
    });
  }
  let scheduleHtml='<h2>Study Schedule</h2><ul id="draggable-list">';
  tasksArr.forEach((item,idx)=>{
    if (item.resource === "Rest/Review Day") {
      scheduleHtml += `<li class="draggable-item" style="background:#fffde3;">
        <b>${item.date}</b>: <span style="color:#d88427;font-weight:bold;">Rest / Review Day</span>
      </li>`;
      return;
    }
    scheduleHtml+=`<li class="draggable-item" draggable="true" data-tid="${item.id}">
      <span class="drag-indicator">&#x2630;</span>
      <input type="checkbox" class="progress-checkbox" data-task="${item.id}" ${item.checked}>
      <b>${item.date}</b>: ${item.resource} <span style="color:#222;font-size:13px;">(${item.type})</span>
      <span style="color:#297bb7;font-size:13px;"> [${item.tag}]</span>,
      Assigned: <b>${item.pages}</b> <span style="font-size:13px;">(${rateTypeLabels[item.type]})</span>
      <span style="color:#777;">Est: ${item.estTime} hrs</span>
      <span style="color:#777; font-style:italic;">${item.resNote}</span>
      <input type="text" class="note-input" data-task-note="${item.id}" placeholder="Add note..." value="${item.note}">
    </li>`;
  });
  scheduleHtml+='</ul>';
  document.getElementById('schedule').innerHTML=scheduleHtml;

  // Drag & drop
  let draggedIdx=null,dragOverIdx=null;
  const list=document.getElementById("draggable-list");
  const items=list?Array.from(list.querySelectorAll('.draggable-item')):[];
  items.forEach((item,idx)=>{
    item.addEventListener("dragstart",(e)=>{draggedIdx=idx;item.classList.add("dragging");});
    item.addEventListener("dragend",(e)=>{
      item.classList.remove("dragging");
      if(typeof draggedIdx==="number"&&typeof dragOverIdx==="number"&&draggedIdx!==dragOverIdx){
        let idList=items.map(i=>i.getAttribute("data-tid"));
        const movingId=idList[draggedIdx];idList.splice(draggedIdx,1);idList.splice(dragOverIdx,0,movingId);
        let manualOrder=loadManualOrder();manualOrder[planConfig.planId]=idList;
        saveProgress(loadProgress(),loadNotes(),manualOrder);
        renderSchedule(planConfig,progress,rebalance,types,skipArr);
      }
      draggedIdx=null;dragOverIdx=null;
    });
    item.addEventListener("dragover",(e)=>{
      e.preventDefault();dragOverIdx=items.indexOf(item);
      items.forEach(i=>i.classList.remove("drop-target"));
      item.classList.add("drop-target");
    });
    item.addEventListener("dragleave",(e)=>{item.classList.remove("drop-target");});
  });

  document.querySelectorAll('.progress-checkbox').forEach(cb=>{
    cb.addEventListener('change',function(){
      let saveData=loadProgress();let saveNotes=loadNotes();let manualOrder=loadManualOrder();
      saveData[planConfig.planId]=saveData[planConfig.planId]||{};
      saveData[planConfig.planId][this.dataset.task]=this.checked?true:false;
      saveProgress(saveData,saveNotes,manualOrder);
      renderSchedule(planConfig,saveData[planConfig.planId],rebalance,types,skipArr);
    });
  });
  document.querySelectorAll('.note-input').forEach(noteInput=>{
    noteInput.addEventListener('change',function(){
      let saveData=loadProgress();let saveNotes=loadNotes();let manualOrder=loadManualOrder();
      saveNotes[planConfig.planId]=saveNotes[planConfig.planId]||{};
      saveNotes[planConfig.planId][this.dataset.taskNote]=this.value;
      saveProgress(saveData,saveNotes,manualOrder);
    });
  });
}

// You may need to implement ICS and PDF export logic using libraries like ics.js and jsPDF
document.getElementById('download-ics-btn').onclick = function() {
  alert("ICS export will only include incomplete items. (Implement actual ICS download here.)");
};
document.getElementById('download-pdf-btn').onclick = function() {
  window.print();
};

function saveProgress(progress, notes, manualOrder) {
  localStorage.setItem('studyProgress', JSON.stringify(progress));
  localStorage.setItem('studyNotes', JSON.stringify(notes));
  localStorage.setItem('studyManualOrder', JSON.stringify(manualOrder));
}
function loadProgress() { return JSON.parse(localStorage.getItem('studyProgress') || '{}'); }
function loadNotes() { return JSON.parse(localStorage.getItem('studyNotes') || '{}'); }
function loadManualOrder() { return JSON.parse(localStorage.getItem('studyManualOrder') || '{}'); }

document.getElementById('backup-btn').onclick = function() {
  if (!lastPlanConfig) { alert('No plan to export!'); return; }
  let json = JSON.stringify({
    planConfig: lastPlanConfig,
    progress: lastProgressCache,
    notes: lastNotesCache,
    manualOrder: lastOrderCache
  });
  let blob=new Blob([json],{type:"application/json"});
  let url=window.URL.createObjectURL(blob);
  let link=document.createElement("a");
  link.href=url;link.download="study_plan_backup.json";
  document.body.appendChild(link);link.click();
  setTimeout(()=>{document.body.removeChild(link);window.URL.revokeObjectURL(url);},100);
};
document.getElementById('restore-btn').onclick = function() {
  document.getElementById('restore-file').click();
};
document.getElementById('restore-file').onchange = function(evt) {
  let file = evt.target.files[0];
  let reader = new FileReader();
  reader.onload = function(e) {
    try {
      let obj = JSON.parse(e.target.result);
      showLoadedSchedule(obj);
      alert('Backup restored!');
    } catch { alert('Could not parse backup.'); }
  };
  if(file)reader.readAsText(file);
};
</script>
</body>
</html>
